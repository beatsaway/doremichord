<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Doremi Chord</title>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        body {
            margin: 0; 
            padding: 0; 
            overflow: hidden;
            background: #2a2a2a;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            touch-action: manipulation;
            height: 100vh;
            height: 100dvh;
        }

        #scene-container { 
            display: none;
        }

        .key-shortcut {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 11px;
            color: #666666;
            font-weight: 400;
            margin-left: 6px;
            letter-spacing: 0.5px;
        }

        .key-shortcut::before {
            content: '¬∑';
            margin-right: 6px;
            color: #404040;
        }

        #mode-buttons {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 0;
            z-index: 1000;
            width: 100%;
            box-sizing: border-box;
        }

        #bass-toggle {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            width: 100%;
        }

        .bass-toggle-button {
            background: #2f2f2f;
            color: #d0d0d0;
            border: none;
            border-right: 1px solid #3a3a3a;
            border-bottom: 1px solid #3a3a3a;
            padding: 12px;
            border-radius: 0;
            font-size: 13px;
            font-weight: 400;
            cursor: pointer;
            user-select: none;
            transition: all 0.15s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.03);
        }

        .bass-toggle-button:hover {
            background: #353535;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
        }

        .bass-toggle-button:last-child {
            border-right: none;
        }

        .settings-button {
            background: #2f2f2f;
            color: #d0d0d0;
            border: none;
            border-bottom: 1px solid #3a3a3a;
            padding: 12px;
            border-radius: 0;
            font-size: 13px;
            font-weight: 400;
            cursor: pointer;
            user-select: none;
            transition: all 0.15s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.03);
        }

        .settings-button:hover {
            background: #353535;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
        }

        .settings-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 0;
        }


        .settings-button:active {
            transform: scale(0.97) translateY(0);
        }

        .settings-button > * {
            position: relative;
            z-index: 1;
            color: inherit;
        }

        .bass-toggle-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 0;
        }

        .bass-toggle-button::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 2px;
            background: currentColor;
            transition: width 0.2s ease;
            z-index: 2;
        }

        .bass-toggle-button.active::after {
            width: 24px;
        }


        .bass-toggle-button:active {
            transform: scale(0.97) translateY(0);
        }

        .bass-toggle-button.active {
            background: #353535;
            color: #ffffff;
        }

        .bass-toggle-button.active::before {
            opacity: 1;
        }

        .bass-toggle-button > * {
            position: relative;
            z-index: 1;
            color: inherit;
        }

        .mode-buttons-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0;
            width: 100%;
        }

        .mode-button {
            background: #2f2f2f;
            color: #d0d0d0;
            border: none;
            border-right: 1px solid #3a3a3a;
            padding: 12px 6px;
            border-radius: 0;
            font-size: 11px;
            font-weight: 400;
            cursor: pointer;
            user-select: none;
            transition: all 0.15s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
            z-index: 1;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.03);
        }

        .mode-button:hover {
            background: #353535;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
        }

        .mode-button:last-child {
            border-right: none;
        }

        .mode-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 0;
        }

        .mode-button::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 2px;
            background: currentColor;
            transition: width 0.2s ease;
            z-index: 2;
        }

        .mode-button.active::after {
            width: 24px;
        }


        .mode-button[data-mode="0"]:active {
            transform: scale(0.96) translateY(0);
        }

        .mode-button[data-mode="1"]:active {
            transform: scale(0.96) translateY(0);
        }

        .mode-button[data-mode="2"]:active {
            transform: scale(0.96) translateY(0);
        }

        .mode-button[data-mode="3"]:active {
            transform: scale(0.96) translateY(0);
        }

        .mode-button[data-mode="0"] {
            background: #2f2f2f;
            color: #00ff9f;
        }

        .mode-button[data-mode="0"].active {
            background: rgba(0, 255, 159, 0.15);
            color: #00ff9f;
        }

        .mode-button[data-mode="0"].active::before {
            opacity: 1;
        }

        .mode-button[data-mode="0"].active:hover {
            color: #00ff9f;
        }

        .mode-button[data-mode="0"].active:active {
            color: #00ff9f;
        }

        .mode-button[data-mode="1"] {
            background: #2f2f2f;
            color: #00b8ff;
        }

        .mode-button[data-mode="1"].active {
            background: rgba(0, 184, 255, 0.15);
            color: #00b8ff;
        }

        .mode-button[data-mode="1"].active::before {
            opacity: 1;
        }

        .mode-button[data-mode="1"].active:hover {
            color: #00b8ff;
        }

        .mode-button[data-mode="1"].active:active {
            color: #00b8ff;
        }

        .mode-button[data-mode="2"] {
            background: #2f2f2f;
            color: #001eff;
        }

        .mode-button[data-mode="2"].active {
            background: rgba(0, 30, 255, 0.15);
            color: #001eff;
        }

        .mode-button[data-mode="2"].active::before {
            opacity: 1;
        }

        .mode-button[data-mode="2"].active:hover {
            color: #001eff;
        }

        .mode-button[data-mode="2"].active:active {
            color: #001eff;
        }

        .mode-button[data-mode="3"] {
            background: #2f2f2f;
            color: #bd00ff;
        }

        .mode-button[data-mode="3"].active {
            background: rgba(189, 0, 255, 0.15);
            color: #bd00ff;
        }

        .mode-button[data-mode="3"].active::before {
            opacity: 1;
        }

        .mode-button[data-mode="3"].active:hover {
            color: #bd00ff;
        }

        .mode-button[data-mode="3"].active:active {
            color: #bd00ff;
        }

        .mode-button > * {
            position: relative;
            z-index: 1;
        }

        #app-info {
            position: fixed;
            top: 100px;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 100;
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        #fastcontrol-container {
            position: relative;
            width: 100%;
            overflow: hidden;
            min-height: 200px;
            display: grid;
            grid-template-columns: 10% 80% 10%;
            align-items: center;
        }

        .fastcontrol {
            display: none;
            width: 100%;
            opacity: 0;
            transform: translateX(0);
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none;
        }

        .fastcontrol.active {
            display: grid;
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
        }

        .fastcontrol.slide-out-left {
            display: grid;
            transform: translateX(-100%);
            opacity: 0;
            pointer-events: none;
        }

        .fastcontrol.slide-out-right {
            display: grid;
            transform: translateX(100%);
            opacity: 0;
            pointer-events: none;
        }

        .fastcontrol.slide-in-left {
            display: grid;
            animation: slideInFromLeft 0.3s ease forwards;
            pointer-events: auto;
        }

        .fastcontrol.slide-in-right {
            display: grid;
            animation: slideInFromRight 0.3s ease forwards;
            pointer-events: auto;
        }

        @keyframes slideInFromLeft {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideInFromRight {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .fastcontrol-wrapper {
            grid-column: 2;
            position: relative;
            width: 100%;
            min-height: 200px;
        }

        .fastcontrol {
            display: flex;
            flex-direction: column;
            align-items: center;
     
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
        }

        .fastcontrol-nav-arrow {
            background: none;
            border: none;
            font-size: 24px;
            color: #ffffff;
            cursor: pointer;
            padding: 2px 0;
            transition: all 0.2s ease;
            opacity: 0.7;
        
            line-height: 1;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 400;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            width: 100%;
            position: relative;
            z-index: 10;
            animation: move-arrow 2s ease-in-out infinite;
        }

        #fastcontrol-prev {
            grid-column: 1;
            justify-content: flex-start;
        }

        #fastcontrol-next {
            grid-column: 3;
            justify-content: flex-end;
        }

        @keyframes move-arrow {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-4px);
            }
        }

        .fastcontrol-nav-arrow:hover {
            opacity: 1;
            color: #d0d0d0;
            animation: none;
            transform: translateY(0);
        }

        .fastcontrol-nav-arrow:active {
            opacity: 0.5;
            transform: translateY(0);
        }

        .fastcontrol-nav-arrow:disabled {
            opacity: 0.2;
            cursor: not-allowed;
            animation: none;
        }

        .fastcontrol-main {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            text-align: center;
        }

        .fastcontrol-slider-label {
            font-size: 11px;
            font-weight: 400;
            color: #b0b0b0;
            margin-bottom: 6px;
            letter-spacing: 0.2px;
        }

        .fastcontrol-slider {
            width: 100%;
            height: 2px;
            border-radius: 1px;
            background: #3a3a3a;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            margin: 0;
            padding: 0 20px;
            box-sizing: border-box;
        }

        .fastcontrol-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #a0a0a0;
            cursor: pointer;
            box-shadow: 0 0 0 2px #0a0a0a;
            transition: all 0.2s ease;
            border: none;
        }

        .fastcontrol-slider::-webkit-slider-thumb:hover {
            background: #ffffff;
            transform: scale(1.1);
        }

        .fastcontrol-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #a0a0a0;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 0 2px #0a0a0a;
            transition: all 0.2s ease;
        }

        .fastcontrol-slider::-moz-range-thumb:hover {
            background: #ffffff;
            transform: scale(1.1);
        }

        .fastcontrol-slider-value {
            font-size: 11px;
            font-weight: 400;
            color: #b0b0b0;
            margin-top: 8px;
            letter-spacing: 0.2px;
        }

        .gate-speed-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .gate-speed-button {
            background: #2f2f2f;
            color: #b0b0b0;
            border: 1px solid #3a3a3a;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 400;
            cursor: pointer;
            user-select: none;
            transition: all 0.15s ease;
            min-width: 50px;
            text-align: center;
        }

        .gate-speed-button:hover {
            background: #353535;
            border-color: #4a4a4a;
            color: #d0d0d0;
        }

        .gate-speed-button.active {
            background: #4a4a4a;
            border-color: #606060;
            color: #ffffff;
        }

        .gate-speed-button:active {
            transform: scale(0.95);
        }

        #rhythm-sequence-display {
            color: #d0d0d0;
            font-weight: 400;
            cursor: default;
        }

        .rhythm-sequence-item {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            transition: all 0.15s ease;
            display: inline-block;
            margin: 0 2px;
        }

        .rhythm-sequence-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .rhythm-sequence-item.selected {
            background: rgba(100, 150, 255, 0.3);
            color: #ffffff;
            font-weight: 500;
        }

        .rhythm-sequence-item.playing {
            color: #ffd700;
            font-weight: 600;
            animation: pulse-yellow 0.5s ease-in-out infinite;
        }

        @keyframes pulse-yellow {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        .app-title {
            font-size: 24px;
            font-weight: 400;
            color: #ffffff;
            margin: 0 0 6px 0;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.2;
            padding: 8px 16px;
            border-radius: 4px;
            display: inline-block;
            position: relative;
        }

        .app-title:hover {
            background: rgba(255, 255, 255, 0.05);
            text-decoration: underline;
            text-decoration-thickness: 1px;
            text-underline-offset: 4px;
        }

        .app-title:active {
            background: rgba(255, 255, 255, 0.08);
        }

        .app-tagline {
            font-size: 13px;
            font-weight: 400;
            color: #b0b0b0;
            margin: 0 0 10px 0;
            letter-spacing: 0.2px;
            line-height: 1.4;
        }

        .app-footer {
            font-size: 11px;
            font-weight: 400;
            color: #909090;
            margin: 0;
            letter-spacing: 0.2px;
            line-height: 1.4;
        }

        .app-footer a {
            color: #a0a0a0;
            text-decoration: underline;
            text-decoration-thickness: 1px;
            text-underline-offset: 2px;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .app-footer a:hover {
            color: #ffffff;
            text-decoration-thickness: 2px;
        }

        #mobile-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr);
            grid-auto-flow: row;
            gap: 0;
            padding: 0;
            background: #2f2f2f;
            z-index: 2000;
            border-top: 1px solid #3a3a3a;
            height: calc(50vh);
            width: 100%;
            box-sizing: border-box;
        }

        .mobile-note-button {
            border: none;
            border-right: 1px solid #3a3a3a;
            border-bottom: 1px solid #3a3a3a;
            border-radius: 0;
            background: #2f2f2f;
            color: #b0b0b0;
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            position: relative;
            overflow: hidden;
            width: 100%;
            height: 100%;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.02);
        }

        .mobile-note-button:nth-child(4n) {
            border-right: none;
        }

        .mobile-note-button:nth-child(n+5) {
            border-bottom: none;
        }

        .mobile-note-button.bass-active {
            box-shadow: inset 0 0 0 1.5px #404040;
        }

        .mobile-note-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: currentColor;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 0;
        }

        .mobile-note-button:hover {
            background: #353535;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.06);
        }

        .mobile-note-button:active {
            transform: scale(0.98);
        }

        .mobile-note-button.active {
            color: #fff !important;
            transform: scale(1);
        }

        .mobile-note-button.active::before {
            opacity: 0.15;
        }

        .mobile-note-button .note-name {
            font-size: 42px;
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1;
            letter-spacing: 1px;
            position: relative;
            z-index: 1;
            transition: transform 0.15s ease;
            color: inherit;
        }

        .mobile-note-button.active .note-name {
            color: #fff !important;
        }

        .mobile-note-button:active .note-name {
            transform: scale(0.9);
        }

        .mobile-note-button.active .note-name {
            transform: scale(1.05);
        }

        .mobile-note-button .note-key {
            font-size: 11px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-weight: 500;
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            position: relative;
            z-index: 1;
            color: #808080;
            transition: all 0.15s ease;
        }

        .mobile-note-button.active .note-key {
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.95) !important;
        }

        @media (max-width: 768px) {
            .mobile-note-button .note-name {
                font-size: 36px;
            }
        }

        @media (max-width: 480px) {
            .mobile-note-button .note-name {
                font-size: 32px;
            }
            
            .mobile-note-button .note-key {
                font-size: 10px;
                padding: 3px 8px;
            }
        }

        @media (max-width: 360px) {
            .mobile-note-button .note-name {
                font-size: 28px;
            }
        }

        /* Settings Modal - Dutch Minimalist Design */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            backdrop-filter: blur(4px);
        }

        .settings-modal.active {
            display: flex;
        }

        .settings-content {
            background: #2f2f2f;
            border-radius: 0;
            padding: 32px 28px;
            max-width: 320px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            position: relative;
            border: 1px solid #3a3a3a;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 32px;
        }

        .settings-title {
            font-size: 14px;
            font-weight: 400;
            color: #ffffff;
            margin: 0;
            letter-spacing: 0.3px;
        }

        .settings-close {
            background: rgba(58, 58, 58, 0.3);
            border: 1px solid rgba(58, 58, 58, 0.5);
            border-radius: 4px;
            font-size: 18px;
            color: #b0b0b0;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            line-height: 1;
        }

        .settings-close:hover {
            color: #ffffff;
            background: rgba(58, 58, 58, 0.6);
            border-color: rgba(90, 90, 90, 0.8);
        }

        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section:last-child {
            margin-bottom: 0;
        }

        .settings-label {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            font-size: 12px;
            font-weight: 400;
            color: #d0d0d0;
            margin-bottom: 8px;
            letter-spacing: 0.2px;
        }

        .settings-slider-container {
            position: relative;
            margin-bottom: 0;
        }

        .settings-slider {
            width: 100%;
            height: 1px;
            border-radius: 0;
            background: #3a3a3a;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .settings-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #a0a0a0;
            cursor: pointer;
            box-shadow: 0 0 0 1px #252525;
            transition: background 0.15s ease;
            border: none;
        }

        .settings-slider::-webkit-slider-thumb:hover {
            background: #ffffff;
        }

        .settings-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #a0a0a0;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 0 1px #252525;
            transition: background 0.15s ease;
        }

        .settings-slider::-moz-range-thumb:hover {
            background: #ffffff;
        }

        .settings-value {
            font-size: 12px;
            font-weight: 400;
            color: #b0b0b0;
            margin-left: 8px;
            letter-spacing: 0.2px;
        }

        .pitch-note-name {
            font-weight: 400;
        }

        /* Info Modal - Dutch Minimalist Design */
        .info-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            backdrop-filter: blur(4px);
        }

        .info-modal.active {
            display: flex;
        }

        .info-content {
            background: #2f2f2f;
            border-radius: 0;
            padding: 32px 28px;
            max-width: 360px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            position: relative;
            border: 1px solid #3a3a3a;
        }

        .info-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }

        .info-title {
            font-size: 14px;
            font-weight: 400;
            color: #ffffff;
            margin: 0;
            letter-spacing: 0.3px;
        }

        .info-close {
            background: rgba(58, 58, 58, 0.3);
            border: 1px solid rgba(58, 58, 58, 0.5);
            border-radius: 4px;
            font-size: 18px;
            color: #b0b0b0;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            line-height: 1;
        }

        .info-close:hover {
            color: #ffffff;
            background: rgba(58, 58, 58, 0.6);
            border-color: rgba(90, 90, 90, 0.8);
        }

        .info-body {
            font-size: 12px;
            font-weight: 400;
            color: #d0d0d0;
            line-height: 1.6;
            letter-spacing: 0.2px;
        }

        .info-body p {
            margin: 0 0 20px 0;
        }

        .info-body p:last-child {
            margin-bottom: 0;
        }

        @media (max-width: 480px) {
            .settings-content {
                padding: 28px 24px;
                max-width: calc(100% - 40px);
            }

            .settings-section {
                margin-bottom: 20px;
            }

            #app-info {
                left: 0;
                right: 0;
                text-align: center;
                width: 100%;
                padding: 20px;
            }
        }

        #hold-indicator {
            position: fixed;
            font-size: 64px;
            pointer-events: none;
            z-index: 2500;
            opacity: 0;
            transition: opacity 0.15s ease;
            user-select: none;
            transform: translate(-40%, -10%);
            will-change: top, left;
        }

        #hold-indicator.visible {
            opacity: 1;
            animation: pulse 0.6s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: translate(-40%, -10%) scale(1);
            }
            50% {
                transform: translate(-40%, -10%) scale(1.2);
            }
        }

        .touch-indicator {
            position: fixed;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #ffd700;
            border: 2px solid #ffed4e;
            pointer-events: none;
            z-index: 2499;
            opacity: 0;
            transition: opacity 0.15s ease;
            transform: translate(-50%, -50%);
            will-change: top, left;
            box-shadow: 0 0 8px rgba(255, 215, 0, 0.6);
        }

        .touch-indicator.visible {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div id="scene-container"></div>
    <div id="mode-buttons">
        <div id="bass-toggle">
            <div class="bass-toggle-button">Bass </div>
            <div class="settings-button">‚öôÔ∏èSettings</div>
        </div>
        <div class="mode-buttons-row">
            <div class="mode-button" data-mode="0">Note</div>
            <div class="mode-button" data-mode="1">Diatonic</div>
            <div class="mode-button" data-mode="2">Jazz7</div>
            <div class="mode-button" data-mode="3">Jazz79</div>
        </div>
    </div>
    
    <!-- App Info Section -->
    <div id="app-info">
        <div id="fastcontrol-container">
            <!-- Fixed Navigation Arrows -->
            <button class="fastcontrol-nav-arrow" id="fastcontrol-prev" disabled>‚óÄ</button>
            
            <!-- Fastcontrol Wrapper (middle 80%) -->
            <div class="fastcontrol-wrapper">
                <!-- Fastcontrol 1: App Info -->
                <div class="fastcontrol active" id="fastcontrol-1">
                    <div class="fastcontrol-main">
                        <div class="app-title" id="app-title-click">Do Re Mi ChordüíÖ</div>
                        <div class="app-tagline">üéµmusic at your finger tip</div>
                        <div class="app-footer">
                            Developed by <a href="https://youtube.com/beatsaway" target="_blank">BeatsAway</a> <br>
                            <a href="https://buymeacoffee.com/beatsaway" target="_blank">Support this developer‚òï</a>
                        </div>
                    </div>
                </div>
                
                <!-- Fastcontrol 2: Gate Control -->
                <div class="fastcontrol" id="fastcontrol-2">
                    <div class="fastcontrol-main">
                        <div class="fastcontrol-slider-label">Gate</div>
                        <input type="range" id="gate-slider" class="fastcontrol-slider" min="0" max="100" step="1" value="0">
                        <div class="fastcontrol-slider-value" id="gate-value">0%</div>
                        
                        <div class="fastcontrol-slider-label" style="margin-top: 20px;">
                            Rhythm <span id="rhythm-sequence-display">(1/4)</span>
                        </div>
                        <div class="gate-speed-buttons">
                            <button class="gate-speed-button" data-note-value="8">1/8</button>
                            <button class="gate-speed-button" data-note-value="8T" data-is-triplet="true">1/8T</button>
                            <button class="gate-speed-button" data-note-value="4">1/4</button>
                            <button class="gate-speed-button" data-note-value="4T" data-is-triplet="true">1/4T</button>
                            <button class="gate-speed-button" data-note-value="2">1/2</button>
                            <button class="gate-speed-button" data-note-value="2T" data-is-triplet="true">1/2T</button>
                            <button class="gate-speed-button" data-note-value="1">1/1</button>
                            <button class="gate-speed-button" data-note-value="1T" data-is-triplet="true">1/1T</button>
                            <button class="gate-speed-button random-button" id="random-rhythm-button">Randomüé≤</button>
                            <button class="gate-speed-button default-button" id="default-rhythm-button">Default</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <button class="fastcontrol-nav-arrow" id="fastcontrol-next">‚ñ∂</button>
        </div>
    </div>
    
    <!-- Modern mobile note buttons -->
    <div id="mobile-buttons">    </div>
    
    <!-- Hold Indicator -->
    <div id="hold-indicator">üëÜ</div>
    
    <!-- Touch Indicators Container (for additional touches) -->
    <div id="touch-indicators-container"></div>
    
    <!-- Info Modal -->
    <div id="info-modal" class="info-modal">
        <div class="info-content">
            <div class="info-header">
                <h2 class="info-title">Did you know? (for most songs)</h2>
                <button class="info-close" id="info-close">&times;</button>
            </div>
            <div class="info-body">
                <p>If you can sing a song in solfa names, you will be able to play it by ear. If you can sing its bass line in solfa names, you will be able to play the bass line as accompaniment or even build chords with it by ear.</p>
                <p>This instrument 'DoReMiChord' is designed exactly for that. Choose in ‚öôÔ∏èsettings the right key of your song and see if you can play along!</p>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="settings-modal">
        <div class="settings-content">
            <div class="settings-header">
                <h2 class="settings-title">‚öôÔ∏èSettings</h2>
                <button class="settings-close" id="settings-close">&times;</button>
            </div>
            
            <div class="settings-section">
                <label class="settings-label" for="volume-slider">
                    Volume
                    <span class="settings-value" id="volume-value">50%</span>
                </label>
                <div class="settings-slider-container">
                    <input type="range" id="volume-slider" class="settings-slider" min="0" max="2" step="0.01" value="0.5">
                </div>
            </div>
            
            <div class="settings-section">
                <label class="settings-label" for="pitch-slider">
                    Fundamental Pitch
                    <span class="settings-value" id="pitch-value">
                        <span class="pitch-note-name">C5</span> (523.25 Hz)
                    </span>
                </label>
                <div class="settings-slider-container">
                    <input type="range" id="pitch-slider" class="settings-slider" min="0" max="24" step="1" value="12">
                </div>
            </div>
            
            <div class="settings-section">
                <label class="settings-label" for="reverb-slider">
                    Reverb Length
                    <span class="settings-value" id="reverb-value">1.0s</span>
                </label>
                <div class="settings-slider-container">
                    <input type="range" id="reverb-slider" class="settings-slider" min="0.1" max="3" step="0.1" value="1.0">
                </div>
            </div>
            
            <div class="settings-section">
                <label class="settings-label" for="bpm-slider">
                    Beats Per Minute
                    <span class="settings-value" id="bpm-value">120</span>
                </label>
                <div class="settings-slider-container">
                    <input type="range" id="bpm-slider" class="settings-slider" min="60" max="200" step="1" value="120">
                </div>
            </div>
        </div>
    </div>
    
    <script src="watersynth.js"></script>
    <script src="audio.js"></script>
    <script>
        // Audio functions and notes are now in audio.js
        
        // Mode visual properties for button colors
        const MODE_VISUALS = {
            0: { rimColor: 0x00ff9f, tintColor: '#2f2f2f' },
            1: { rimColor: 0x00b8ff, tintColor: '#2f2f2f' },
            2: { rimColor: 0x001eff, tintColor: '#2f2f2f' },
            3: { rimColor: 0xbd00ff, tintColor: '#2f2f2f' }
        };
        
        // Function to update note button colors based on mode
        function updateNoteButtonColors() {
            const modeTint = MODE_VISUALS[currentMode].tintColor;
            
            document.querySelectorAll('.mobile-note-button').forEach(button => {
                // Only update if button is not currently active
                if (!button.classList.contains('active')) {
                    // Use mode tint color directly (no individual note colors)
                    button.style.background = modeTint;
                }
            });
        }
        
        // Store note indices for audio playback (no plates needed)
        const noteIndices = MAJOR_SCALE_RATIOS.map((_, i) => i);
        
        // Keyboard controls
        const keyMap = {};
        MAJOR_SCALE_RATIOS.forEach(note => {
            if (note.key) {
                keyMap[note.key] = note;
            }
        });
        
        // Track which keys are currently pressed (to prevent repeat triggers)
        const pressedKeys = new Set();
        
        // Track mode: 0 = Note, 1 = Diatonic, 2 = Jazz7, 3 = Jazz79
        let currentMode = 3; // 0 = Note mode, 1-3 = Chord modes (default: Jazz79 mode)
        
        // Mode names
        const MODE_NAMES = ['Note', 'Diatonic', 'Jazz7', 'Jazz79'];
        
        // Function to update mode display
        function updateModeDisplay() {
            // Update visual state of mode buttons
            document.querySelectorAll('.mode-button').forEach(btn => {
                const mode = parseInt(btn.getAttribute('data-mode'));
                if (mode === currentMode) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Update note button colors based on mode
            updateNoteButtonColors();
        }
        
        // Handle mode button clicks
        document.querySelectorAll('.mode-button').forEach(btn => {
            btn.addEventListener('click', () => {
                const mode = parseInt(btn.getAttribute('data-mode'));
                currentMode = mode;
                updateModeDisplay();
            });
        });
        
        // Function to update bass mode display
        function updateBassDisplay() {
            // Update bass toggle button
            const bassToggleButton = document.querySelector('.bass-toggle-button');
            if (bassToggleButton) {
                if (window.bassMode) {
                    bassToggleButton.classList.add('active');
                } else {
                    bassToggleButton.classList.remove('active');
                }
            }
            
            // Update border on note buttons when bass is active
            document.querySelectorAll('.mobile-note-button').forEach(button => {
                if (window.bassMode) {
                    button.classList.add('bass-active');
                } else {
                    button.classList.remove('bass-active');
                }
            });
        }
        
        // Handle bass toggle button click
        document.querySelector('.bass-toggle-button')?.addEventListener('click', () => {
            window.bassMode = !window.bassMode;
            updateBassDisplay();
        });
        
        // Handle mode selection (1, 2, 3, 4 keys) and bass toggle (Space)
        document.addEventListener('keydown', (event) => {
            // Handle mode selection with number keys
            if (event.key === '1' && !event.repeat) {
                currentMode = 0; // Note mode
                updateModeDisplay();
                return;
            }
            if (event.key === '2' && !event.repeat) {
                currentMode = 1; // Diatonic
                updateModeDisplay();
                return;
            }
            if (event.key === '3' && !event.repeat) {
                currentMode = 2; // Jazz7
                updateModeDisplay();
                return;
            }
            if (event.key === '4' && !event.repeat) {
                currentMode = 3; // Jazz79
                updateModeDisplay();
                return;
            }
            
            // Handle bass toggle (Space)
            if (event.key === ' ' && !event.repeat) {
                event.preventDefault(); // Prevent page scroll
                window.bassMode = !window.bassMode;
                updateBassDisplay();
                return;
            }
        });
        
        // Initialize mode display
        updateModeDisplay();
        updateBassDisplay();
        
        // Initialize note button colors
        updateNoteButtonColors();
        
        // Create mobile-friendly buttons
        // Layout: Row 1 = La, Ti, Do, Re | Row 2 = Mi, Fa, So, La
        const mobileButtonsContainer = document.getElementById('mobile-buttons');
        const mobileButtons = [];
        const buttonByKey = {}; // Map keyboard keys to button elements
        const holdIndicator = document.getElementById('hold-indicator');
        
        MAJOR_SCALE_RATIOS.forEach((note, index) => {
            const button = document.createElement('div');
            button.className = 'mobile-note-button';
            button.setAttribute('data-note-index', index);
            button.setAttribute('data-note-key', note.key);
            
            const noteName = document.createElement('div');
            noteName.className = 'note-name';
            noteName.textContent = note.name.replace('Lower ', '');
            
            button.appendChild(noteName);
            
            // Touch/click handlers for mobile buttons
            let isButtonPressed = false;
            
            // Pitch bend parameters
            const PITCH_BEND_DEAD_ZONE = 8; // Percentage threshold before pitch changes (8%)
            const PITCH_BEND_MAX = 30; // Maximum percentage offset (30%)
            const HALF_STEPS_PER_PERCENT = 0.5 / 10; // 0.5 half-steps per 10% beyond dead zone
            
            // Helper function to get Y position from event
            // For touch events, finds the touch point that matches this button's touch identifier
            const getYPosition = (e) => {
                if (e.touches && e.touches.length > 0) {
                    const rect = button.getBoundingClientRect();
                    // If we have a stored touch identifier, find the matching touch point
                    if (button.userData && button.userData.touchIdentifier !== undefined) {
                        // Find the touch point that matches our stored identifier
                        for (let i = 0; i < e.touches.length; i++) {
                            if (e.touches[i].identifier === button.userData.touchIdentifier) {
                                return e.touches[i].clientY - rect.top;
                            }
                        }
                        // If touch identifier not found (shouldn't happen), fall back to first touch
                        return e.touches[0].clientY - rect.top;
                    } else {
                        // No touch identifier stored yet, use first touch (for initial touchstart)
                        return e.touches[0].clientY - rect.top;
                    }
                } else {
                    // Mouse event
                    const rect = button.getBoundingClientRect();
                    return e.clientY - rect.top;
                }
            };
            
            // Helper function to calculate pitch bend from Y position
            const calculatePitchBend = (yPosition) => {
                const rect = button.getBoundingClientRect();
                const buttonHeight = rect.height;
                const buttonCenter = buttonHeight / 2;
                const offsetY = yPosition - buttonCenter;
                const offsetPercent = (offsetY / buttonHeight) * 100;
                
                // Apply dead zone - no pitch change if within threshold
                if (Math.abs(offsetPercent) < PITCH_BEND_DEAD_ZONE) {
                    return 1.0; // No pitch bend
                }
                
                // Clamp to maximum range
                const clampedPercent = Math.max(-PITCH_BEND_MAX, Math.min(PITCH_BEND_MAX, offsetPercent));
                
                // Calculate effective percentage beyond dead zone
                const effectivePercent = clampedPercent > 0 
                    ? clampedPercent - PITCH_BEND_DEAD_ZONE 
                    : clampedPercent + PITCH_BEND_DEAD_ZONE;
                
                // Convert to half-steps (0.5 half-steps per 10% beyond dead zone)
                const halfSteps = effectivePercent * HALF_STEPS_PER_PERCENT;
                
                // Convert half-steps to frequency multiplier
                // Each half-step multiplies frequency by 2^(1/12)
                const multiplier = Math.pow(2, halfSteps / 12);
                
                return multiplier;
            };
            
            // Handle movement for pitch bending
            const handleMove = (e) => {
                if (!isButtonPressed || !button.userData) return;
                
                e.preventDefault();
                const yPosition = getYPosition(e);
                const pitchBendMultiplier = calculatePitchBend(yPosition);
                
                // Update pitch in real-time
                if (window.updatePitchBend) {
                    window.updatePitchBend(button.userData.noteKey, pitchBendMultiplier);
                }
            };
            
            const handleStart = (e) => {
                e.preventDefault();
                if (isButtonPressed) return;
                isButtonPressed = true;
                
                const noteIndex = parseInt(button.getAttribute('data-note-index'));
                const noteKey = `mobile-${index}-${Date.now()}`;
                
                // Store touch identifier for touch events (for multi-touch support)
                let touchIdentifier = null;
                if (e.touches && e.touches.length > 0) {
                    // Find the touch point that started on this button
                    // We need to find which touch in e.touches corresponds to this button
                    // Since touchstart fires per element, e.changedTouches[0] should be the one
                    if (e.changedTouches && e.changedTouches.length > 0) {
                        touchIdentifier = e.changedTouches[0].identifier;
                    } else if (e.touches.length > 0) {
                        // Fallback: use the first touch
                        touchIdentifier = e.touches[0].identifier;
                    }
                }
                
                playNoteForButton(noteIndex, noteKey);
                button.classList.add('active');
                
                // Apply mode color as background when active (darker version)
                const modeColor = MODE_VISUALS[currentMode].rimColor;
                const activeColor = '#' + modeColor.toString(16).padStart(6, '0');
                button.style.background = activeColor;
                button.style.borderRightColor = activeColor;
                button.style.borderBottomColor = activeColor;
                
                // Store note data and touch identifier
                button.userData = { noteKey, noteIndex, touchIdentifier };
                
                // Initialize pitch bend based on initial position
                const yPosition = getYPosition(e);
                const pitchBendMultiplier = calculatePitchBend(yPosition);
                if (window.updatePitchBend) {
                    window.updatePitchBend(noteKey, pitchBendMultiplier);
                }
            };
            
            const handleEnd = (e) => {
                e.preventDefault();
                if (!isButtonPressed) return;
                
                // For touch events, verify this is the correct touch ending
                if (e.changedTouches && e.changedTouches.length > 0 && button.userData) {
                    const endedTouchIdentifier = e.changedTouches[0].identifier;
                    // Check if this touchend matches our stored touch identifier
                    // Also check all changedTouches in case multiple touches end simultaneously
                    let touchMatches = false;
                    for (let i = 0; i < e.changedTouches.length; i++) {
                        if (e.changedTouches[i].identifier === button.userData.touchIdentifier) {
                            touchMatches = true;
                            break;
                        }
                    }
                    
                    // If we have a stored touch identifier and it doesn't match, skip this touchend
                    // BUT: if touchIdentifier is null/undefined (mouse event or touch lost), allow release
                    if (button.userData.touchIdentifier !== null && 
                        button.userData.touchIdentifier !== undefined &&
                        !touchMatches) {
                        return; // This touchend is for a different touch
                    }
                }
                
                isButtonPressed = false;
                
                if (button.userData) {
                    // Reset pitch to original before stopping
                    if (window.updatePitchBend) {
                        window.updatePitchBend(button.userData.noteKey, 1.0);
                    }
                    
                    stopNoteByKey(button.userData.noteKey);
                    button.classList.remove('active');
                    
                    // Reset to mode-tinted color
                    const modeTint = MODE_VISUALS[currentMode].tintColor;
                    button.style.background = modeTint;
                    button.style.borderRightColor = '#e8e6e3';
                    button.style.borderBottomColor = '#e8e6e3';
                    
                    button.userData = null;
                }
            };
            
            // Support both touch and mouse events
            button.addEventListener('touchstart', handleStart, { passive: false });
            button.addEventListener('touchmove', handleMove, { passive: false });
            button.addEventListener('touchend', handleEnd, { passive: false });
            button.addEventListener('touchcancel', handleEnd, { passive: false });
            button.addEventListener('mousedown', handleStart);
            button.addEventListener('mousemove', handleMove);
            button.addEventListener('mouseup', handleEnd);
            button.addEventListener('mouseleave', handleEnd);
            
            mobileButtonsContainer.appendChild(button);
            mobileButtons.push(button);
            
            // Store button reference by key for keyboard visual feedback
            if (note.key) {
                buttonByKey[note.key] = button;
            }
        });
        
        // Touch tracking system - emoji for first touch, yellow circles for others
        const touchIndicatorsContainer = document.getElementById('touch-indicators-container');
        const activeTouchIndicators = new Map(); // Map of touch identifier -> indicator element
        
        // Helper function to update touch indicators
        function updateTouchIndicators(e) {
            // Handle both touch events (e.touches) and mouse events
            const touches = e.touches || [];
            
            // Update emoji indicator for first touch
            if (holdIndicator && touches.length > 0) {
                holdIndicator.style.left = touches[0].clientX + 'px';
                holdIndicator.style.top = touches[0].clientY + 'px';
                holdIndicator.classList.add('visible');
            } else if (holdIndicator && touches.length === 0) {
                holdIndicator.classList.remove('visible');
            }
            
            // Create/update yellow circles for touches 2, 3, 4, etc.
            const currentTouchIds = new Set();
            
            // Process all current touches
            for (let i = 0; i < touches.length; i++) {
                const touch = touches[i];
                currentTouchIds.add(touch.identifier);
                
                // First touch uses emoji, skip it
                if (i === 0) continue;
                
                // Get or create indicator for this touch
                let indicator = activeTouchIndicators.get(touch.identifier);
                if (!indicator) {
                    indicator = document.createElement('div');
                    indicator.className = 'touch-indicator';
                    touchIndicatorsContainer.appendChild(indicator);
                    activeTouchIndicators.set(touch.identifier, indicator);
                }
                
                // Update position
                indicator.style.left = touch.clientX + 'px';
                indicator.style.top = touch.clientY + 'px';
                indicator.classList.add('visible');
            }
            
            // Remove indicators for touches that are no longer active
            // Also check changedTouches for touches that just ended
            const endedTouchIds = new Set();
            if (e.changedTouches) {
                for (let i = 0; i < e.changedTouches.length; i++) {
                    // Skip first touch (emoji indicator)
                    if (i === 0 && touches.length === 0) continue;
                    endedTouchIds.add(e.changedTouches[i].identifier);
                }
            }
            
            for (const [touchId, indicator] of activeTouchIndicators.entries()) {
                if (!currentTouchIds.has(touchId) || endedTouchIds.has(touchId)) {
                    indicator.classList.remove('visible');
                    // Remove from DOM after transition
                    setTimeout(() => {
                        if (indicator && indicator.parentNode) {
                            indicator.parentNode.removeChild(indicator);
                        }
                        activeTouchIndicators.delete(touchId);
                    }, 150);
                }
            }
        }
        
        // Mouse events (single touch simulation)
        document.addEventListener('mousedown', (e) => {
            if (holdIndicator) {
                holdIndicator.style.left = e.clientX + 'px';
                holdIndicator.style.top = e.clientY + 'px';
                holdIndicator.classList.add('visible');
            }
        });
        
        document.addEventListener('mousemove', (e) => {
            if (holdIndicator && holdIndicator.classList.contains('visible')) {
                holdIndicator.style.left = e.clientX + 'px';
                holdIndicator.style.top = e.clientY + 'px';
            }
        });
        
        document.addEventListener('mouseup', () => {
            if (holdIndicator) {
                holdIndicator.classList.remove('visible');
            }
        });
        
        // Touch events (multi-touch support)
        document.addEventListener('touchstart', (e) => {
            updateTouchIndicators(e);
        });
        
        document.addEventListener('touchmove', (e) => {
            updateTouchIndicators(e);
        });
        
        document.addEventListener('touchend', (e) => {
            updateTouchIndicators(e);
            
            // Fallback: If all touches are released, ensure all notes are stopped
            // This handles edge cases where touch identifiers might get lost
            if (e.touches.length === 0) {
                // Check all buttons and release any that are still pressed
                document.querySelectorAll('.mobile-note-button').forEach(btn => {
                    if (btn.classList.contains('active') && btn.userData) {
                        // Force release if button is still active but no touches remain
                        const noteKey = btn.userData.noteKey;
                        if (noteKey && window.stopNoteByKey) {
                            window.stopNoteByKey(noteKey);
                            btn.classList.remove('active');
                            const modeTint = MODE_VISUALS[currentMode].tintColor;
                            btn.style.background = modeTint;
                            btn.style.borderRightColor = '#e8e6e3';
                            btn.style.borderBottomColor = '#e8e6e3';
                            btn.userData = null;
                        }
                    }
                });
            }
        });
        
        document.addEventListener('touchcancel', (e) => {
            updateTouchIndicators(e);
            
            // Fallback: If all touches are cancelled, ensure all notes are stopped
            // This handles edge cases where touch identifiers might get lost
            if (e.touches.length === 0) {
                // Check all buttons and release any that are still pressed
                document.querySelectorAll('.mobile-note-button').forEach(btn => {
                    if (btn.classList.contains('active') && btn.userData) {
                        // Force release if button is still active but no touches remain
                        const noteKey = btn.userData.noteKey;
                        if (noteKey && window.stopNoteByKey) {
                            window.stopNoteByKey(noteKey);
                            btn.classList.remove('active');
                            const modeTint = MODE_VISUALS[currentMode].tintColor;
                            btn.style.background = modeTint;
                            btn.style.borderRightColor = '#e8e6e3';
                            btn.style.borderBottomColor = '#e8e6e3';
                            btn.userData = null;
                        }
                    }
                });
            }
        });
        
        // Resume audio on any user interaction
        document.addEventListener('click', resumeAudioContext, { once: true });
        document.addEventListener('keydown', resumeAudioContext, { once: true });
        document.addEventListener('touchstart', resumeAudioContext, { once: true });
        
        // Helper function to play note/chord for a button
        function playNoteForButton(noteIndex, noteKey) {
            if (currentMode === 0) {
                // Note mode - play single note
                const frequency = getNoteFrequency(noteIndex);
                startNote(frequency, noteKey, noteIndex);
            } else {
                // Chord modes (1 = Diatonic, 2 = Jazz7, 3 = Jazz79)
                let extensions = [];
                if (currentMode === 2) {
                    // Jazz7
                    extensions = getJazz7Extensions(noteIndex);
                } else if (currentMode === 3) {
                    // Jazz79
                    extensions = getJazz79Extensions(noteIndex);
                }
                // currentMode === 1 (Diatonic) uses empty extensions array
                startChord(noteIndex, noteKey, extensions);
            }
        }
        
        // Attack phase: Start note/chord when key is pressed
        document.addEventListener('keydown', (event) => {
            const key = event.key.toLowerCase();
            
            // Prevent repeat triggers if key is already held
            if (pressedKeys.has(key) || !keyMap[key]) {
                return;
            }
            
            pressedKeys.add(key);
            
            const noteIndex = MAJOR_SCALE_RATIOS.findIndex(n => n.key === key);
            const noteKey = key;
            
            // Visual feedback: activate corresponding button
            const button = buttonByKey[key];
            if (button) {
                button.classList.add('active');
                // Apply mode color as background when active (darker version)
                const modeColor = MODE_VISUALS[currentMode].rimColor;
                const activeColor = '#' + modeColor.toString(16).padStart(6, '0');
                button.style.background = activeColor;
                button.style.borderRightColor = activeColor;
                button.style.borderBottomColor = activeColor;
            }
            
            playNoteForButton(noteIndex, noteKey);
        });
        
        // Release phase: Stop note/chord when key is released
        document.addEventListener('keyup', (event) => {
            const key = event.key.toLowerCase();
            
            if (!keyMap[key]) {
                return;
            }
            
            pressedKeys.delete(key);
            
            // Visual feedback: deactivate corresponding button
            const button = buttonByKey[key];
            if (button) {
                button.classList.remove('active');
                
                // Reset to mode-tinted color
                const modeTint = MODE_VISUALS[currentMode].tintColor;
                button.style.background = modeTint;
                button.style.borderRightColor = '#e8e6e3';
                button.style.borderBottomColor = '#e8e6e3';
            }
            
            const noteKey = key;
            stopNoteByKey(noteKey);
        });
        
        // Stop all notes if window loses focus (prevents stuck notes)
        window.addEventListener('blur', () => {
            stopAllNotes();
            pressedKeys.clear();
            
            // Reset all button states
            document.querySelectorAll('.mobile-note-button').forEach(button => {
                button.classList.remove('active');
                
                // Reset to mode-tinted color
                const modeTint = MODE_VISUALS[currentMode].tintColor;
                button.style.background = modeTint;
                button.style.borderRightColor = '#e8e6e3';
                button.style.borderBottomColor = '#e8e6e3';
                button.userData = null;
            });
        });

        // Info Modal Functionality
        const infoModal = document.getElementById('info-modal');
        const appTitleClick = document.getElementById('app-title-click');
        const infoClose = document.getElementById('info-close');

        // Open info modal when title is clicked
        appTitleClick.addEventListener('click', () => {
            infoModal.classList.add('active');
        });

        // Close info modal
        infoClose.addEventListener('click', () => {
            infoModal.classList.remove('active');
        });

        // Close modal when clicking outside
        infoModal.addEventListener('click', (e) => {
            if (e.target === infoModal) {
                infoModal.classList.remove('active');
            }
        });

        // Settings Modal Functionality
        const settingsModal = document.getElementById('settings-modal');
        const settingsButton = document.querySelector('.settings-button');
        const settingsClose = document.getElementById('settings-close');
        const volumeSlider = document.getElementById('volume-slider');
        const volumeValue = document.getElementById('volume-value');
        const pitchSlider = document.getElementById('pitch-slider');
        const pitchValue = document.getElementById('pitch-value');
        const reverbSlider = document.getElementById('reverb-slider');
        const reverbValue = document.getElementById('reverb-value');
        const bpmSlider = document.getElementById('bpm-slider');
        const bpmValue = document.getElementById('bpm-value');

        // Note names for pitch display (C3 to C5, 24 half steps)
        const noteNames = [
            'C3', 'C#3', 'D3', 'D#3', 'E3', 'F3', 'F#3', 'G3', 'G#3', 'A3', 'A#3', 'B3',
            'C4', 'C#4', 'D4', 'D#4', 'E4', 'F4', 'F#4', 'G4', 'G#4', 'A4', 'A#4', 'B4',
            'C5'
        ];

        // Calculate frequency from half steps (C3 = 0, C4 = 12, C5 = 24)
        // Using Equal Temperament for root, then Just Intonation ratios apply
        function getFrequencyFromHalfSteps(halfSteps) {
            // C3 = 130.81 Hz (C4 / 2)
            const c3Freq = 130.81;
            // Each half step multiplies by 2^(1/12)
            return c3Freq * Math.pow(2, halfSteps / 12);
        }

        // Open settings modal
        settingsButton.addEventListener('click', () => {
            settingsModal.classList.add('active');
        });

        // Close settings modal
        settingsClose.addEventListener('click', () => {
            settingsModal.classList.remove('active');
        });

        // Close modal when clicking outside
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.classList.remove('active');
            }
        });

        // Volume slider handler
        volumeSlider.addEventListener('input', (e) => {
            const volume = parseFloat(e.target.value);
            const volumePercent = Math.round(volume * 100);
            volumeValue.textContent = volumePercent + '%';
            
            // Update master gain (0 to 2 range, allowing up to 200% volume)
            if (window.waterSynth && window.waterSynth.masterGain) {
                window.waterSynth.masterGain.gain.value = volume;
            }
        });

        // Pitch slider handler
        pitchSlider.addEventListener('input', (e) => {
            const halfSteps = parseInt(e.target.value);
            const frequency = getFrequencyFromHalfSteps(halfSteps);
            const noteName = noteNames[halfSteps];
            
            pitchValue.innerHTML = `<span class="pitch-note-name">${noteName}</span> (${frequency.toFixed(2)} Hz)`;
            
            // Update root frequency (this will affect all new notes)
            if (typeof updateRootFrequency === 'function') {
                updateRootFrequency(frequency);
            }
        });

        // Reverb slider handler
        reverbSlider.addEventListener('input', (e) => {
            const reverbLength = parseFloat(e.target.value);
            reverbValue.textContent = reverbLength.toFixed(1) + 's';
            
            // Update reverb length
            if (window.waterSynth) {
                window.waterSynth.reverbLength = reverbLength;
                window.waterSynth.reverb.buffer = window.waterSynth.createImpulseResponse(reverbLength);
            }
        });

        // BPM slider handler
        // Store BPM globally for future use
        window.bpm = 120; // Default BPM
        
        bpmSlider.addEventListener('input', (e) => {
            const bpm = parseInt(e.target.value);
            bpmValue.textContent = bpm;
            
            // Update global BPM value
            window.bpm = bpm;
            
            // Restart gate loop with new BPM timing
            if (typeof updateGateSpeedSequence === 'function' && selectedGateSpeeds.length > 0) {
                updateGateSpeedSequence(selectedGateSpeeds);
            }
        });

        // Initialize volume display and sync with current masterGain
        if (window.waterSynth && window.waterSynth.masterGain) {
            const currentGain = window.waterSynth.masterGain.gain.value;
            volumeSlider.value = currentGain;
            volumeValue.textContent = Math.round(currentGain * 100) + '%';
        } else {
            const initialVolume = parseFloat(volumeSlider.value);
            volumeValue.textContent = Math.round(initialVolume * 100) + '%';
        }
        
        // Initialize pitch display
        const initialHalfSteps = parseInt(pitchSlider.value);
        const initialFreq = getFrequencyFromHalfSteps(initialHalfSteps);
        pitchValue.innerHTML = `<span class="pitch-note-name">${noteNames[initialHalfSteps]}</span> (${initialFreq.toFixed(2)} Hz)`;
        
        // Make sure initial root frequency matches slider (C4 = 12 half steps from C3)
        if (typeof updateRootFrequency === 'function') {
            updateRootFrequency(initialFreq);
        }
        
        // Initialize reverb display
        const initialReverb = parseFloat(reverbSlider.value);
        reverbValue.textContent = initialReverb.toFixed(1) + 's';

        // Initialize BPM display
        const initialBPM = parseInt(bpmSlider.value);
        bpmValue.textContent = initialBPM;
        window.bpm = initialBPM;

        // Fastcontrol Navigation
        let currentFastcontrol = 1;
        const totalFastcontrols = 2;

        function updateFastcontrolDisplay(direction = null) {
            const allFastcontrols = document.querySelectorAll('.fastcontrol');
            const currentElement = document.getElementById(`fastcontrol-${currentFastcontrol}`);
            const previousElement = Array.from(allFastcontrols).find(fc => fc.classList.contains('active'));
            
            if (!currentElement) {
                console.error(`Fastcontrol ${currentFastcontrol} not found`);
                return;
            }
            
            // Remove all active classes and animation classes
            allFastcontrols.forEach(fc => {
                fc.classList.remove('active', 'slide-out-left', 'slide-out-right', 'slide-in-left', 'slide-in-right');
            });
            
            // Animate out the previous element
            if (previousElement && previousElement !== currentElement && direction) {
                if (direction === 'next') {
                    previousElement.classList.add('slide-out-left');
                } else if (direction === 'prev') {
                    previousElement.classList.add('slide-out-right');
                }
            }
            
            // Check if we're leaving fastcontrol-2
            const wasFastcontrol2 = previousElement && previousElement.id === 'fastcontrol-2';
            const isLeavingFastcontrol2 = wasFastcontrol2 && currentFastcontrol !== 2;
            
            // Show and animate in the current element
            setTimeout(() => {
                if (direction === 'next') {
                    currentElement.classList.add('slide-in-right', 'active');
                } else if (direction === 'prev') {
                    currentElement.classList.add('slide-in-left', 'active');
                } else {
                    currentElement.classList.add('active');
                }
                
                // Auto-activate gate when visiting fastcontrol-2 panel
                if (currentFastcontrol === 2) {
                    const gateSlider = document.getElementById('gate-slider');
                    const gateValue = document.getElementById('gate-value');
                    if (gateSlider && gateValue) {
                        gateSlider.value = 76;
                        gateValue.textContent = '76%';
                        if (typeof updateGateAmount === 'function') {
                            updateGateAmount(76);
                        }
                    }
                }
                
                // Auto-deactivate gate when leaving fastcontrol-2 panel
                if (isLeavingFastcontrol2) {
                    const gateSlider = document.getElementById('gate-slider');
                    const gateValue = document.getElementById('gate-value');
                    if (gateSlider && gateValue) {
                        gateSlider.value = 0;
                        gateValue.textContent = '0%';
                        if (typeof updateGateAmount === 'function') {
                            updateGateAmount(0);
                        }
                    }
                }
            }, direction ? 50 : 10);
            
            // Update navigation arrows
            const prevArrow = document.getElementById('fastcontrol-prev');
            const nextArrow = document.getElementById('fastcontrol-next');
            
            if (prevArrow && nextArrow) {
                // Enable both arrows first
                prevArrow.disabled = false;
                nextArrow.disabled = false;
                
                // Disable prev arrow on first, next arrow on last
                if (currentFastcontrol === 1) {
                    prevArrow.disabled = true;
                }
                if (currentFastcontrol === totalFastcontrols) {
                    nextArrow.disabled = true;
                }
            }
        }

        // Navigation arrow handlers
        const prevArrow = document.getElementById('fastcontrol-prev');
        const nextArrow = document.getElementById('fastcontrol-next');
        
        if (prevArrow) {
            prevArrow.addEventListener('click', () => {
                if (currentFastcontrol > 1) {
                    currentFastcontrol--;
                    updateFastcontrolDisplay('prev');
                }
            });
        }
        
        if (nextArrow) {
            nextArrow.addEventListener('click', () => {
                if (currentFastcontrol < totalFastcontrols) {
                    currentFastcontrol++;
                    updateFastcontrolDisplay('next');
                }
            });
        }

        // Gate Slider (ducking amount)
        const gateSlider = document.getElementById('gate-slider');
        const gateValue = document.getElementById('gate-value');

        gateSlider.addEventListener('input', (e) => {
            const amount = parseInt(e.target.value);
            gateValue.textContent = amount + '%';
            
            // Update gate amount (ducking effect)
            if (typeof updateGateAmount === 'function') {
                updateGateAmount(amount);
            }
        });

        // Gate Speed Buttons - Typewriter style (append to sequence)
        const gateSpeedButtons = document.querySelectorAll('.gate-speed-button');
        const rhythmSequenceDisplay = document.getElementById('rhythm-sequence-display');
        let rhythmSequence = ["4"]; // Array to store sequence (e.g., ["4", "2", "1"])
        let selectedSequenceIndex = 0; // Index of selected item in sequence (0 = first item selected by default)
        let isRandomEnabled = false; // Track if random mode is enabled
        let playingSequenceIndex = -1; // Index of currently playing item (-1 = none playing)
        
        // Map note values to display names
        const noteValueToName = {
            "8": "1/8",
            "8T": "1/8T",
            "4": "1/4",
            "4T": "1/4T",
            "2": "1/2",
            "2T": "1/2T",
            "1": "1/1",
            "1T": "1/1T"
        };
        
        // Function to update the sequence display
        function updateSequenceDisplay() {
            const items = rhythmSequence.map((noteValue, index) => {
                const name = noteValueToName[noteValue] || noteValue;
                const isSelected = index === selectedSequenceIndex;
                const isPlaying = index === playingSequenceIndex;
                const classes = [
                    'rhythm-sequence-item',
                    isSelected ? 'selected' : '',
                    isPlaying ? 'playing' : ''
                ].filter(Boolean).join(' ');
                return `<span class="${classes}" data-index="${index}">${name}</span>`;
            }).join(',');
            rhythmSequenceDisplay.innerHTML = `(${items})`;
            
            // Add click handlers to sequence items
            rhythmSequenceDisplay.querySelectorAll('.rhythm-sequence-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = parseInt(item.getAttribute('data-index'));
                    // Toggle selection
                    if (selectedSequenceIndex === index) {
                        selectedSequenceIndex = -1; // Deselect
                    } else {
                        selectedSequenceIndex = index; // Select
                    }
                    updateSequenceDisplay();
                });
            });
        }
        
        // Function to update the playing index (called from audio.js)
        window.updatePlayingSequenceIndex = function(index) {
            playingSequenceIndex = index;
            updateSequenceDisplay();
        };
        
        // Function to update the gate sequence
        function updateGateSequence() {
            if (typeof updateGateSpeedSequence === 'function') {
                updateGateSpeedSequence(rhythmSequence, isRandomEnabled);
            }
        }
        
        gateSpeedButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Check if this is the Random button
                if (button.id === 'random-rhythm-button') {
                    // Toggle random mode
                    isRandomEnabled = !isRandomEnabled;
                    if (isRandomEnabled) {
                        button.classList.add('active');
                    } else {
                        button.classList.remove('active');
                    }
                    updateGateSequence();
                    return;
                }
                
                // Check if this is the Default button
                if (button.id === 'default-rhythm-button') {
                    rhythmSequence = ["4"];
                    selectedSequenceIndex = 0; // Select first item by default
                    updateSequenceDisplay();
                    updateGateSequence();
                    return;
                }
                
                // Handle regular note value buttons
                const noteValue = button.getAttribute('data-note-value'); // Can be "8", "8T", etc.
                if (!noteValue) return; // Skip if no note value
                
                // If an item is selected, replace it
                if (selectedSequenceIndex >= 0 && selectedSequenceIndex < rhythmSequence.length) {
                    rhythmSequence[selectedSequenceIndex] = noteValue;
                    selectedSequenceIndex = -1; // Clear selection after replacement
                } else {
                    // Otherwise, append to sequence
                    rhythmSequence.push(noteValue);
                }
                
                updateSequenceDisplay();
                updateGateSequence();
            });
        });

        // Initialize gate display
        const initialGateAmount = parseInt(gateSlider.value);
        gateValue.textContent = initialGateAmount + '%';
        if (typeof updateGateAmount === 'function') {
            updateGateAmount(initialGateAmount);
        }

        // Initialize rhythm sequence display and gate sequence
        updateSequenceDisplay();
        updateGateSequence();

        // Initialize fastcontrol display
        updateFastcontrolDisplay();
    </script>
</body>
</html>
