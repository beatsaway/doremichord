<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Doremi Chord</title>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        body {
            margin: 0; 
            padding: 0; 
            overflow: hidden;
            background: #f5f5f5;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            touch-action: manipulation;
            height: 100vh;
            height: 100dvh;
        }

        #scene-container { 
            display: none;
        }

        .key-shortcut {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 11px;
            color: #999;
            font-weight: 400;
            margin-left: 6px;
            letter-spacing: 0.5px;
        }

        .key-shortcut::before {
            content: '¬∑';
            margin-right: 6px;
            color: #ccc;
        }

        #mode-buttons {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 0;
            z-index: 1000;
            width: 100%;
            box-sizing: border-box;
        }

        #bass-toggle {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            width: 100%;
        }

        .bass-toggle-button {
            background: #fff;
            color: #666;
            border: none;
            border-right: 1px solid #e0e0e0;
            border-bottom: 1px solid #e0e0e0;
            padding: 16px;
            border-radius: 0;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .bass-toggle-button:last-child {
            border-right: none;
        }

        .settings-button {
            background: #fff;
            color: #666;
            border: none;
            border-bottom: 1px solid #e0e0e0;
            padding: 16px;
            border-radius: 0;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .settings-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 0;
        }


        .settings-button:active {
            transform: scale(0.97) translateY(0);
        }

        .settings-button > * {
            position: relative;
            z-index: 1;
            color: inherit;
        }

        .bass-toggle-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 0;
        }

        .bass-toggle-button::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 2px;
            background: currentColor;
            transition: width 0.2s ease;
            z-index: 2;
        }

        .bass-toggle-button.active::after {
            width: 24px;
        }


        .bass-toggle-button:active {
            transform: scale(0.97) translateY(0);
        }

        .bass-toggle-button.active {
            background: #e0e0e0;
            color: #666;
        }

        .bass-toggle-button.active::before {
            opacity: 1;
        }

        .bass-toggle-button > * {
            position: relative;
            z-index: 1;
            color: inherit;
        }

        .mode-buttons-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0;
            width: 100%;
        }

        .mode-button {
            background: #fff;
            color: #666;
            border: none;
            border-right: 1px solid #e0e0e0;
            padding: 16px 8px;
            border-radius: 0;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .mode-button:last-child {
            border-right: none;
        }

        .mode-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 0;
        }

        .mode-button::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 2px;
            background: currentColor;
            transition: width 0.2s ease;
            z-index: 2;
        }

        .mode-button.active::after {
            width: 24px;
        }


        .mode-button[data-mode="0"]:active {
            transform: scale(0.96) translateY(0);
        }

        .mode-button[data-mode="1"]:active {
            transform: scale(0.96) translateY(0);
        }

        .mode-button[data-mode="2"]:active {
            transform: scale(0.96) translateY(0);
        }

        .mode-button[data-mode="3"]:active {
            transform: scale(0.96) translateY(0);
        }

        .mode-button[data-mode="0"] {
            background: #fff;
            color: #1976d2;
        }

        .mode-button[data-mode="0"].active {
            background: #e3f2fd;
            color: #1976d2;
        }

        .mode-button[data-mode="0"].active::before {
            opacity: 1;
        }

        .mode-button[data-mode="0"].active:hover {
            color: #1976d2;
        }

        .mode-button[data-mode="0"].active:active {
            color: #1976d2;
        }

        .mode-button[data-mode="1"] {
            background: #fff;
            color: #2a9d8f;
        }

        .mode-button[data-mode="1"].active {
            background: #e0f7f5;
            color: #2a9d8f;
        }

        .mode-button[data-mode="1"].active::before {
            opacity: 1;
        }

        .mode-button[data-mode="1"].active:hover {
            color: #2a9d8f;
        }

        .mode-button[data-mode="1"].active:active {
            color: #2a9d8f;
        }

        .mode-button[data-mode="2"] {
            background: #fff;
            color: #5f3dc4;
        }

        .mode-button[data-mode="2"].active {
            background: #ede9ff;
            color: #5f3dc4;
        }

        .mode-button[data-mode="2"].active::before {
            opacity: 1;
        }

        .mode-button[data-mode="2"].active:hover {
            color: #5f3dc4;
        }

        .mode-button[data-mode="2"].active:active {
            color: #5f3dc4;
        }

        .mode-button[data-mode="3"] {
            background: #fff;
            color: #d63031;
        }

        .mode-button[data-mode="3"].active {
            background: #ffe5e5;
            color: #d63031;
        }

        .mode-button[data-mode="3"].active::before {
            opacity: 1;
        }

        .mode-button[data-mode="3"].active:hover {
            color: #d63031;
        }

        .mode-button[data-mode="3"].active:active {
            color: #d63031;
        }

        .mode-button > * {
            position: relative;
            z-index: 1;
        }

        #app-info {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 100;
            padding: 20px;
            max-width: none;
            width: auto;
            pointer-events: none;
        }

        .app-title {
            font-size: 28px;
            font-weight: 400;
            color: #000;
            margin: 0 0 12px 0;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            transition: opacity 0.2s ease;
            pointer-events: auto;
            white-space: nowrap;
        }

        .app-title:hover {
            opacity: 0.6;
        }

        .app-tagline {
            font-size: 16px;
            font-weight: 400;
            color: #666;
            margin: 0 0 20px 0;
            letter-spacing: 0.5px;
            line-height: 1.6;
        }

        .app-footer {
            font-size: 14px;
            font-weight: 400;
            color: #999;
            margin: 0;
            letter-spacing: 0.5px;
        }

        .app-footer a {
            color: #000;
            text-decoration: none;
            transition: opacity 0.2s ease;
            pointer-events: auto;
        }

        .app-footer a:hover {
            opacity: 0.5;
        }

        #mobile-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr);
            grid-auto-flow: row;
            gap: 0;
            padding: 0;
            background: #fff;
            z-index: 2000;
            border-top: 1px solid #e0e0e0;
            height: calc(50vh);
            width: 100%;
            box-sizing: border-box;
        }

        .mobile-note-button {
            border: none;
            border-right: 1px solid #e0e0e0;
            border-bottom: 1px solid #e0e0e0;
            border-radius: 0;
            background: #fafafa;
            color: #333;
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            user-select: none;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            position: relative;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }

        .mobile-note-button:nth-child(4n) {
            border-right: none;
        }

        .mobile-note-button:nth-child(n+5) {
            border-bottom: none;
        }

        .mobile-note-button.bass-active {
            box-shadow: inset 0 0 0 1px #333;
        }

        .mobile-note-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: currentColor;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 0;
        }

        .mobile-note-button:hover {
            background: #f0f0f0;
        }

        .mobile-note-button:active {
            transform: scale(0.98);
        }

        .mobile-note-button.active {
            color: #fff !important;
            transform: scale(1);
        }

        .mobile-note-button.active::before {
            opacity: 0.15;
        }

        .mobile-note-button .note-name {
            font-size: 42px;
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1;
            letter-spacing: 1px;
            position: relative;
            z-index: 1;
            text-transform: uppercase;
            transition: transform 0.15s ease;
            color: inherit;
        }

        .mobile-note-button.active .note-name {
            color: #fff !important;
        }

        .mobile-note-button:active .note-name {
            transform: scale(0.9);
        }

        .mobile-note-button.active .note-name {
            transform: scale(1.05);
        }

        .mobile-note-button .note-key {
            font-size: 11px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-weight: 500;
            padding: 4px 10px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
            position: relative;
            z-index: 1;
            color: #666;
            transition: all 0.15s ease;
        }

        .mobile-note-button.active .note-key {
            background: rgba(255, 255, 255, 0.25);
            color: rgba(255, 255, 255, 0.95) !important;
        }

        @media (max-width: 768px) {
            .mobile-note-button .note-name {
                font-size: 36px;
            }
        }

        @media (max-width: 480px) {
            .mobile-note-button .note-name {
                font-size: 32px;
            }
            
            .mobile-note-button .note-key {
                font-size: 10px;
                padding: 3px 8px;
            }
        }

        @media (max-width: 360px) {
            .mobile-note-button .note-name {
                font-size: 28px;
            }
        }

        /* Settings Modal - Dutch Minimalist Design */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            backdrop-filter: blur(2px);
        }

        .settings-modal.active {
            display: flex;
        }

        .settings-content {
            background: #fff;
            border-radius: 0;
            padding: 48px 40px;
            max-width: 360px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            position: relative;
            border: 1px solid #f5f5f5;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 48px;
        }

        .settings-title {
            font-size: 16px;
            font-weight: 400;
            color: #000;
            margin: 0;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .settings-close {
            background: none;
            border: none;
            font-size: 20px;
            color: #000;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.15s ease;
            line-height: 1;
            opacity: 0.6;
        }

        .settings-close:hover {
            opacity: 1;
        }

        .settings-section {
            margin-bottom: 40px;
        }

        .settings-section:last-child {
            margin-bottom: 0;
        }

        .settings-label {
            display: block;
            font-size: 11px;
            font-weight: 400;
            color: #666;
            margin-bottom: 16px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .settings-slider-container {
            position: relative;
            margin-bottom: 12px;
        }

        .settings-slider {
            width: 100%;
            height: 2px;
            border-radius: 0;
            background: #e5e5e5;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .settings-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 0;
            background: #000;
            cursor: pointer;
            box-shadow: none;
            transition: transform 0.15s ease;
            transform: rotate(45deg);
        }

        .settings-slider::-webkit-slider-thumb:hover {
            transform: rotate(45deg) scale(1.15);
        }

        .settings-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 0;
            background: #000;
            cursor: pointer;
            border: none;
            box-shadow: none;
            transition: transform 0.15s ease;
            transform: rotate(45deg);
        }

        .settings-slider::-moz-range-thumb:hover {
            transform: rotate(45deg) scale(1.15);
        }

        .settings-value {
            font-size: 13px;
            font-weight: 400;
            color: #000;
            margin-top: 12px;
            text-align: left;
            letter-spacing: 0.3px;
        }

        .pitch-note-name {
            font-weight: 500;
        }

        /* Info Modal - Dutch Minimalist Design */
        .info-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            backdrop-filter: blur(2px);
        }

        .info-modal.active {
            display: flex;
        }

        .info-content {
            background: #fff;
            border-radius: 0;
            padding: 48px 40px;
            max-width: 420px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            position: relative;
            border: 1px solid #f5f5f5;
        }

        .info-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 32px;
        }

        .info-title {
            font-size: 16px;
            font-weight: 400;
            color: #000;
            margin: 0;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .info-close {
            background: none;
            border: none;
            font-size: 20px;
            color: #000;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.15s ease;
            line-height: 1;
            opacity: 0.6;
        }

        .info-close:hover {
            opacity: 1;
        }

        .info-body {
            font-size: 13px;
            font-weight: 400;
            color: #000;
            line-height: 1.8;
            letter-spacing: 0.2px;
        }

        .info-body p {
            margin: 0 0 20px 0;
        }

        .info-body p:last-child {
            margin-bottom: 0;
        }

        @media (max-width: 480px) {
            .settings-content {
                padding: 40px 32px;
                max-width: calc(100% - 40px);
            }

            .settings-section {
                margin-bottom: 36px;
            }

            #app-info {
                left: 20px;
                transform: none;
                text-align: left;
                max-width: none;
                width: auto;
                padding: 20px 0;
            }
        }
    </style>
</head>
<body>
    <div id="scene-container"></div>
    <div id="mode-buttons">
        <div id="bass-toggle">
            <div class="bass-toggle-button">Bass <span class="key-shortcut">Spacebar</span></div>
            <div class="settings-button">‚öôÔ∏èSettings</div>
        </div>
        <div class="mode-buttons-row">
            <div class="mode-button" data-mode="0">Note mode <span class="key-shortcut">1</span></div>
            <div class="mode-button" data-mode="1">Diatonic mode <span class="key-shortcut">2</span></div>
            <div class="mode-button" data-mode="2">Jazz7 mode <span class="key-shortcut">3</span></div>
            <div class="mode-button" data-mode="3">Jazz79 mode <span class="key-shortcut">4</span></div>
        </div>
    </div>
    
    <!-- App Info Section -->
    <div id="app-info"><br>
        <div class="app-title" id="app-title-click">üëÅÔ∏èDo Re Mi ChordüëÅÔ∏è</div>
        <div class="app-tagline">easiest music app at your finger tipüíÖ</div>
        <div class="app-footer">
            Developed by <a href="https://youtube.com/beatsaway" target="_blank">BeatsAway</a> <br>
            <a href="https://buymeacoffee.com/beatsaway" target="_blank">Support this developer</a>
        </div>
    </div>
    
    <!-- Modern mobile note buttons -->
    <div id="mobile-buttons">    </div>
    
    <!-- Info Modal -->
    <div id="info-modal" class="info-modal">
        <div class="info-content">
            <div class="info-header">
                <h2 class="info-title">About</h2>
                <button class="info-close" id="info-close">&times;</button>
            </div>
            <div class="info-body">
                <p>Do you know? You can play almost any songs by ear with just Do Re Mi Fa So La Ti notes!</p>
                <p>This instrument 'DoReMiChord' is made exactly for that. Tune in ‚öôÔ∏èsettings the right key of your favourite song and see if you can play along!</p>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="settings-modal">
        <div class="settings-content">
            <div class="settings-header">
                <h2 class="settings-title">‚öôÔ∏èSettings</h2>
                <button class="settings-close" id="settings-close">&times;</button>
            </div>
            
            <div class="settings-section">
                <label class="settings-label" for="volume-slider">Volume</label>
                <div class="settings-slider-container">
                    <input type="range" id="volume-slider" class="settings-slider" min="0" max="2" step="0.01" value="0.5">
                    <span class="settings-value" id="volume-value">50%</span>
                </div>
            </div>
            
            <div class="settings-section">
                <label class="settings-label" for="pitch-slider">Fundamental Pitch</label>
                <div class="settings-slider-container">
                    <input type="range" id="pitch-slider" class="settings-slider" min="0" max="24" step="1" value="12">
                    <span class="settings-value" id="pitch-value">
                        <span class="pitch-note-name">C4</span> (261.63 Hz)
                    </span>
                </div>
            </div>
            
            <div class="settings-section">
                <label class="settings-label" for="reverb-slider">Reverb Length</label>
                <div class="settings-slider-container">
                    <input type="range" id="reverb-slider" class="settings-slider" min="0.1" max="3" step="0.1" value="1.0">
                    <span class="settings-value" id="reverb-value">1.0s</span>
                </div>
            </div>
        </div>
    </div>
    
    <script src="watersynth.js"></script>
    <script src="audio.js"></script>
    <script>
        // Audio functions and notes are now in audio.js
        
        // Mode visual properties for button colors
        const MODE_VISUALS = {
            0: { rimColor: 0x3498db, tintColor: '#e3f2fd' },  // Note mode - blue
            1: { rimColor: 0x4ecdc4, tintColor: '#e0f7f5' },  // Diatonic - teal tint
            2: { rimColor: 0x6c5ce7, tintColor: '#ede9ff' },  // Jazz7 - purple tint
            3: { rimColor: 0xff6b6b, tintColor: '#ffe5e5' }   // Jazz79 - red tint
        };
        
        // Function to update note button colors based on mode
        function updateNoteButtonColors() {
            const modeTint = MODE_VISUALS[currentMode].tintColor;
            
            document.querySelectorAll('.mobile-note-button').forEach(button => {
                // Only update if button is not currently active
                if (!button.classList.contains('active')) {
                    // Use mode tint color directly (no individual note colors)
                    button.style.background = modeTint;
                }
            });
        }
        
        // Store note indices for audio playback (no plates needed)
        const noteIndices = MAJOR_SCALE_RATIOS.map((_, i) => i);
        
        // Keyboard controls
        const keyMap = {};
        MAJOR_SCALE_RATIOS.forEach(note => {
            if (note.key) {
                keyMap[note.key] = note;
            }
        });
        
        // Track which keys are currently pressed (to prevent repeat triggers)
        const pressedKeys = new Set();
        
        // Track mode: 0 = Note, 1 = Diatonic, 2 = Jazz7, 3 = Jazz79
        let currentMode = 1; // 0 = Note mode, 1-3 = Chord modes (default: Diatonic)
        
        // Mode names
        const MODE_NAMES = ['Note', 'Diatonic', 'Jazz7', 'Jazz79'];
        
        // Function to update mode display
        function updateModeDisplay() {
            // Update visual state of mode buttons
            document.querySelectorAll('.mode-button').forEach(btn => {
                const mode = parseInt(btn.getAttribute('data-mode'));
                if (mode === currentMode) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Update note button colors based on mode
            updateNoteButtonColors();
        }
        
        // Handle mode button clicks
        document.querySelectorAll('.mode-button').forEach(btn => {
            btn.addEventListener('click', () => {
                const mode = parseInt(btn.getAttribute('data-mode'));
                currentMode = mode;
                updateModeDisplay();
            });
        });
        
        // Function to update bass mode display
        function updateBassDisplay() {
            // Update bass toggle button
            const bassToggleButton = document.querySelector('.bass-toggle-button');
            if (bassToggleButton) {
                if (window.bassMode) {
                    bassToggleButton.classList.add('active');
                } else {
                    bassToggleButton.classList.remove('active');
                }
            }
            
            // Update border on note buttons when bass is active
            document.querySelectorAll('.mobile-note-button').forEach(button => {
                if (window.bassMode) {
                    button.classList.add('bass-active');
                } else {
                    button.classList.remove('bass-active');
                }
            });
        }
        
        // Handle bass toggle button click
        document.querySelector('.bass-toggle-button')?.addEventListener('click', () => {
            window.bassMode = !window.bassMode;
            updateBassDisplay();
        });
        
        // Handle mode selection (1, 2, 3, 4 keys) and bass toggle (Space)
        document.addEventListener('keydown', (event) => {
            // Handle mode selection with number keys
            if (event.key === '1' && !event.repeat) {
                currentMode = 0; // Note mode
                updateModeDisplay();
                return;
            }
            if (event.key === '2' && !event.repeat) {
                currentMode = 1; // Diatonic
                updateModeDisplay();
                return;
            }
            if (event.key === '3' && !event.repeat) {
                currentMode = 2; // Jazz7
                updateModeDisplay();
                return;
            }
            if (event.key === '4' && !event.repeat) {
                currentMode = 3; // Jazz79
                updateModeDisplay();
                return;
            }
            
            // Handle bass toggle (Space)
            if (event.key === ' ' && !event.repeat) {
                event.preventDefault(); // Prevent page scroll
                window.bassMode = !window.bassMode;
                updateBassDisplay();
                return;
            }
        });
        
        // Initialize mode display
        updateModeDisplay();
        updateBassDisplay();
        
        // Initialize note button colors
        updateNoteButtonColors();
        
        // Create mobile-friendly buttons
        // Layout: Row 1 = La, Ti, Do, Re | Row 2 = Mi, Fa, So, La
        const mobileButtonsContainer = document.getElementById('mobile-buttons');
        const mobileButtons = [];
        const buttonByKey = {}; // Map keyboard keys to button elements
        
        MAJOR_SCALE_RATIOS.forEach((note, index) => {
            const button = document.createElement('div');
            button.className = 'mobile-note-button';
            button.setAttribute('data-note-index', index);
            button.setAttribute('data-note-key', note.key);
            
            const noteName = document.createElement('div');
            noteName.className = 'note-name';
            noteName.textContent = note.name.replace('Lower ', '');
            
            const noteKey = document.createElement('div');
            noteKey.className = 'note-key';
            noteKey.textContent = note.key.toUpperCase();
            
            button.appendChild(noteName);
            button.appendChild(noteKey);
            
            // Touch/click handlers for mobile buttons
            let isButtonPressed = false;
            
            const handleStart = (e) => {
                e.preventDefault();
                if (isButtonPressed) return;
                isButtonPressed = true;
                
                const noteIndex = parseInt(button.getAttribute('data-note-index'));
                const noteKey = `mobile-${index}-${Date.now()}`;
                
                playNoteForButton(noteIndex, noteKey);
                button.classList.add('active');
                
                // Apply mode color as background when active (darker version)
                const modeColor = MODE_VISUALS[currentMode].rimColor;
                const activeColor = '#' + modeColor.toString(16).padStart(6, '0');
                button.style.background = activeColor;
                button.style.borderRightColor = activeColor;
                button.style.borderBottomColor = activeColor;
                
                button.userData = { noteKey, noteIndex };
            };
            
            const handleEnd = (e) => {
                e.preventDefault();
                if (!isButtonPressed) return;
                isButtonPressed = false;
                
                if (button.userData) {
                    stopNoteByKey(button.userData.noteKey);
                    button.classList.remove('active');
                    
                    // Reset to mode-tinted color
                    const modeTint = MODE_VISUALS[currentMode].tintColor;
                    button.style.background = modeTint;
                    button.style.borderRightColor = '#e0e0e0';
                    button.style.borderBottomColor = '#e0e0e0';
                    
                    button.userData = null;
                }
            };
            
            // Support both touch and mouse events
            button.addEventListener('touchstart', handleStart, { passive: false });
            button.addEventListener('touchend', handleEnd, { passive: false });
            button.addEventListener('touchcancel', handleEnd, { passive: false });
            button.addEventListener('mousedown', handleStart);
            button.addEventListener('mouseup', handleEnd);
            button.addEventListener('mouseleave', handleEnd);
            
            mobileButtonsContainer.appendChild(button);
            mobileButtons.push(button);
            
            // Store button reference by key for keyboard visual feedback
            if (note.key) {
                buttonByKey[note.key] = button;
            }
        });
        
        // Resume audio on any user interaction
        document.addEventListener('click', resumeAudioContext, { once: true });
        document.addEventListener('keydown', resumeAudioContext, { once: true });
        document.addEventListener('touchstart', resumeAudioContext, { once: true });
        
        // Helper function to play note/chord for a button
        function playNoteForButton(noteIndex, noteKey) {
            if (currentMode === 0) {
                // Note mode - play single note
                const frequency = getNoteFrequency(noteIndex);
                startNote(frequency, noteKey, noteIndex);
            } else {
                // Chord modes (1 = Diatonic, 2 = Jazz7, 3 = Jazz79)
                let extensions = [];
                if (currentMode === 2) {
                    // Jazz7
                    extensions = getJazz7Extensions(noteIndex);
                } else if (currentMode === 3) {
                    // Jazz79
                    extensions = getJazz79Extensions(noteIndex);
                }
                // currentMode === 1 (Diatonic) uses empty extensions array
                startChord(noteIndex, noteKey, extensions);
            }
        }
        
        // Attack phase: Start note/chord when key is pressed
        document.addEventListener('keydown', (event) => {
            const key = event.key.toLowerCase();
            
            // Prevent repeat triggers if key is already held
            if (pressedKeys.has(key) || !keyMap[key]) {
                return;
            }
            
            pressedKeys.add(key);
            
            const noteIndex = MAJOR_SCALE_RATIOS.findIndex(n => n.key === key);
            const noteKey = key;
            
            // Visual feedback: activate corresponding button
            const button = buttonByKey[key];
            if (button) {
                button.classList.add('active');
                // Apply mode color as background when active (darker version)
                const modeColor = MODE_VISUALS[currentMode].rimColor;
                const activeColor = '#' + modeColor.toString(16).padStart(6, '0');
                button.style.background = activeColor;
                button.style.borderRightColor = activeColor;
                button.style.borderBottomColor = activeColor;
            }
            
            playNoteForButton(noteIndex, noteKey);
        });
        
        // Release phase: Stop note/chord when key is released
        document.addEventListener('keyup', (event) => {
            const key = event.key.toLowerCase();
            
            if (!keyMap[key]) {
                return;
            }
            
            pressedKeys.delete(key);
            
            // Visual feedback: deactivate corresponding button
            const button = buttonByKey[key];
            if (button) {
                button.classList.remove('active');
                
                // Reset to mode-tinted color
                const modeTint = MODE_VISUALS[currentMode].tintColor;
                button.style.background = modeTint;
                button.style.borderRightColor = '#e0e0e0';
                button.style.borderBottomColor = '#e0e0e0';
            }
            
            const noteKey = key;
            stopNoteByKey(noteKey);
        });
        
        // Stop all notes if window loses focus (prevents stuck notes)
        window.addEventListener('blur', () => {
            stopAllNotes();
            pressedKeys.clear();
            
            // Reset all button states
            document.querySelectorAll('.mobile-note-button').forEach(button => {
                button.classList.remove('active');
                
                // Reset to mode-tinted color
                const modeTint = MODE_VISUALS[currentMode].tintColor;
                button.style.background = modeTint;
                button.style.borderRightColor = '#e0e0e0';
                button.style.borderBottomColor = '#e0e0e0';
                button.userData = null;
            });
        });

        // Info Modal Functionality
        const infoModal = document.getElementById('info-modal');
        const appTitleClick = document.getElementById('app-title-click');
        const infoClose = document.getElementById('info-close');

        // Open info modal when title is clicked
        appTitleClick.addEventListener('click', () => {
            infoModal.classList.add('active');
        });

        // Close info modal
        infoClose.addEventListener('click', () => {
            infoModal.classList.remove('active');
        });

        // Close modal when clicking outside
        infoModal.addEventListener('click', (e) => {
            if (e.target === infoModal) {
                infoModal.classList.remove('active');
            }
        });

        // Settings Modal Functionality
        const settingsModal = document.getElementById('settings-modal');
        const settingsButton = document.querySelector('.settings-button');
        const settingsClose = document.getElementById('settings-close');
        const volumeSlider = document.getElementById('volume-slider');
        const volumeValue = document.getElementById('volume-value');
        const pitchSlider = document.getElementById('pitch-slider');
        const pitchValue = document.getElementById('pitch-value');
        const reverbSlider = document.getElementById('reverb-slider');
        const reverbValue = document.getElementById('reverb-value');

        // Note names for pitch display (C3 to C5, 24 half steps)
        const noteNames = [
            'C3', 'C#3', 'D3', 'D#3', 'E3', 'F3', 'F#3', 'G3', 'G#3', 'A3', 'A#3', 'B3',
            'C4', 'C#4', 'D4', 'D#4', 'E4', 'F4', 'F#4', 'G4', 'G#4', 'A4', 'A#4', 'B4',
            'C5'
        ];

        // Calculate frequency from half steps (C3 = 0, C4 = 12, C5 = 24)
        // Using Equal Temperament for root, then Just Intonation ratios apply
        function getFrequencyFromHalfSteps(halfSteps) {
            // C3 = 130.81 Hz (C4 / 2)
            const c3Freq = 130.81;
            // Each half step multiplies by 2^(1/12)
            return c3Freq * Math.pow(2, halfSteps / 12);
        }

        // Open settings modal
        settingsButton.addEventListener('click', () => {
            settingsModal.classList.add('active');
        });

        // Close settings modal
        settingsClose.addEventListener('click', () => {
            settingsModal.classList.remove('active');
        });

        // Close modal when clicking outside
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.classList.remove('active');
            }
        });

        // Volume slider handler
        volumeSlider.addEventListener('input', (e) => {
            const volume = parseFloat(e.target.value);
            const volumePercent = Math.round(volume * 100);
            volumeValue.textContent = volumePercent + '%';
            
            // Update master gain (0 to 2 range, allowing up to 200% volume)
            if (window.waterSynth && window.waterSynth.masterGain) {
                window.waterSynth.masterGain.gain.value = volume;
            }
        });

        // Pitch slider handler
        pitchSlider.addEventListener('input', (e) => {
            const halfSteps = parseInt(e.target.value);
            const frequency = getFrequencyFromHalfSteps(halfSteps);
            const noteName = noteNames[halfSteps];
            
            pitchValue.innerHTML = `<span class="pitch-note-name">${noteName}</span> (${frequency.toFixed(2)} Hz)`;
            
            // Update root frequency (this will affect all new notes)
            if (typeof updateRootFrequency === 'function') {
                updateRootFrequency(frequency);
            }
        });

        // Reverb slider handler
        reverbSlider.addEventListener('input', (e) => {
            const reverbLength = parseFloat(e.target.value);
            reverbValue.textContent = reverbLength.toFixed(1) + 's';
            
            // Update reverb length
            if (window.waterSynth) {
                window.waterSynth.reverbLength = reverbLength;
                window.waterSynth.reverb.buffer = window.waterSynth.createImpulseResponse(reverbLength);
            }
        });

        // Initialize volume display and sync with current masterGain
        if (window.waterSynth && window.waterSynth.masterGain) {
            const currentGain = window.waterSynth.masterGain.gain.value;
            volumeSlider.value = currentGain;
            volumeValue.textContent = Math.round(currentGain * 100) + '%';
        } else {
            const initialVolume = parseFloat(volumeSlider.value);
            volumeValue.textContent = Math.round(initialVolume * 100) + '%';
        }
        
        // Initialize pitch display
        const initialHalfSteps = parseInt(pitchSlider.value);
        const initialFreq = getFrequencyFromHalfSteps(initialHalfSteps);
        pitchValue.innerHTML = `<span class="pitch-note-name">${noteNames[initialHalfSteps]}</span> (${initialFreq.toFixed(2)} Hz)`;
        
        // Make sure initial root frequency matches slider (C4 = 12 half steps from C3)
        if (typeof updateRootFrequency === 'function') {
            updateRootFrequency(initialFreq);
        }
        
        // Initialize reverb display
        const initialReverb = parseFloat(reverbSlider.value);
        reverbValue.textContent = initialReverb.toFixed(1) + 's';
    </script>
</body>
</html>
