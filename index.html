<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Doremi Chord</title>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        body {
            margin: 0; 
            padding: 0; 
            overflow: hidden;
            background: #f5f5f5;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            touch-action: manipulation;
            height: 100vh;
            height: 100dvh;
        }

        #scene-container { 
            display: none;
        }

        .key-shortcut {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 11px;
            color: #999;
            font-weight: 400;
            margin-left: 6px;
            letter-spacing: 0.5px;
        }

        .key-shortcut::before {
            content: 'Â·';
            margin-right: 6px;
            color: #ccc;
        }

        #mode-buttons {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 0;
            z-index: 1000;
            width: 100%;
            box-sizing: border-box;
        }

        #bass-toggle {
            width: 100%;
        }

        .bass-toggle-button {
            background: #fff;
            color: #666;
            border: none;
            border-bottom: 1px solid #e0e0e0;
            padding: 16px;
            border-radius: 0;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .bass-toggle-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 0;
        }

        .bass-toggle-button:hover {
            border-color: #000;
            transform: translateY(-1px);
        }

        .bass-toggle-button:active {
            transform: scale(0.97) translateY(0);
        }

        .bass-toggle-button.active {
            background: #e0e0e0;
            color: #666;
            border-color: #000;
        }

        .bass-toggle-button.active::before {
            opacity: 1;
        }

        .bass-toggle-button > * {
            position: relative;
            z-index: 1;
            color: inherit;
        }

        .mode-buttons-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0;
            width: 100%;
        }

        .mode-button {
            background: #fff;
            color: #666;
            border: none;
            border-right: 1px solid #e0e0e0;
            padding: 16px 8px;
            border-radius: 0;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .mode-button:last-child {
            border-right: none;
        }

        .mode-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 0;
        }

        .mode-button:hover {
            border-color: #000;
            transform: translateY(-1px);
        }

        .mode-button[data-mode="0"]:active {
            transform: scale(0.96) translateY(0);
        }

        .mode-button[data-mode="1"]:active {
            transform: scale(0.96) translateY(0);
        }

        .mode-button[data-mode="2"]:active {
            transform: scale(0.96) translateY(0);
        }

        .mode-button[data-mode="3"]:active {
            transform: scale(0.96) translateY(0);
        }

        .mode-button[data-mode="0"] {
            background: #fff;
            color: #1976d2;
        }

        .mode-button[data-mode="0"].active {
            background: #e3f2fd;
            color: #1976d2;
        }

        .mode-button[data-mode="0"].active::before {
            opacity: 1;
        }

        .mode-button[data-mode="0"].active:hover {
            color: #1976d2;
        }

        .mode-button[data-mode="0"].active:active {
            color: #1976d2;
        }

        .mode-button[data-mode="1"] {
            background: #fff;
            color: #2a9d8f;
        }

        .mode-button[data-mode="1"].active {
            background: #e0f7f5;
            color: #2a9d8f;
        }

        .mode-button[data-mode="1"].active::before {
            opacity: 1;
        }

        .mode-button[data-mode="1"].active:hover {
            color: #2a9d8f;
        }

        .mode-button[data-mode="1"].active:active {
            color: #2a9d8f;
        }

        .mode-button[data-mode="2"] {
            background: #fff;
            color: #5f3dc4;
        }

        .mode-button[data-mode="2"].active {
            background: #ede9ff;
            color: #5f3dc4;
        }

        .mode-button[data-mode="2"].active::before {
            opacity: 1;
        }

        .mode-button[data-mode="2"].active:hover {
            color: #5f3dc4;
        }

        .mode-button[data-mode="2"].active:active {
            color: #5f3dc4;
        }

        .mode-button[data-mode="3"] {
            background: #fff;
            color: #d63031;
        }

        .mode-button[data-mode="3"].active {
            background: #ffe5e5;
            color: #d63031;
        }

        .mode-button[data-mode="3"].active::before {
            opacity: 1;
        }

        .mode-button[data-mode="3"].active:hover {
            color: #d63031;
        }

        .mode-button[data-mode="3"].active:active {
            color: #d63031;
        }

        .mode-button > * {
            position: relative;
            z-index: 1;
        }

        #mobile-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr);
            grid-auto-flow: row;
            gap: 0;
            padding: 0;
            background: #fff;
            z-index: 2000;
            border-top: 1px solid #e0e0e0;
            height: calc(50vh);
            width: 100%;
            box-sizing: border-box;
        }

        .mobile-note-button {
            border: none;
            border-right: 1px solid #e0e0e0;
            border-bottom: 1px solid #e0e0e0;
            border-radius: 0;
            background: #fafafa;
            color: #333;
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            user-select: none;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            position: relative;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }

        .mobile-note-button:nth-child(4n) {
            border-right: none;
        }

        .mobile-note-button:nth-child(n+5) {
            border-bottom: none;
        }

        .mobile-note-button.bass-active {
            box-shadow: inset 0 0 0 1px #333;
        }

        .mobile-note-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: currentColor;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 0;
        }

        .mobile-note-button:hover {
            background: #f0f0f0;
        }

        .mobile-note-button:active {
            transform: scale(0.98);
        }

        .mobile-note-button.active {
            color: #fff !important;
            transform: scale(1);
        }

        .mobile-note-button.active::before {
            opacity: 0.15;
        }

        .mobile-note-button .note-name {
            font-size: 42px;
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1;
            letter-spacing: 1px;
            position: relative;
            z-index: 1;
            text-transform: uppercase;
            transition: transform 0.15s ease;
            color: inherit;
        }

        .mobile-note-button.active .note-name {
            color: #fff !important;
        }

        .mobile-note-button:active .note-name {
            transform: scale(0.9);
        }

        .mobile-note-button.active .note-name {
            transform: scale(1.05);
        }

        .mobile-note-button .note-key {
            font-size: 11px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-weight: 500;
            padding: 4px 10px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
            position: relative;
            z-index: 1;
            color: #666;
            transition: all 0.15s ease;
        }

        .mobile-note-button.active .note-key {
            background: rgba(255, 255, 255, 0.25);
            color: rgba(255, 255, 255, 0.95) !important;
        }

        @media (max-width: 768px) {
            .mobile-note-button .note-name {
                font-size: 36px;
            }
        }

        @media (max-width: 480px) {
            .mobile-note-button .note-name {
                font-size: 32px;
            }
            
            .mobile-note-button .note-key {
                font-size: 10px;
                padding: 3px 8px;
            }
        }

        @media (max-width: 360px) {
            .mobile-note-button .note-name {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <div id="scene-container"></div>
    <div id="mode-buttons">
        <div id="bass-toggle">
            <div class="bass-toggle-button">Bass <span class="key-shortcut">Spacebar</span></div>
        </div>
        <div class="mode-buttons-row">
            <div class="mode-button" data-mode="0">Note <span class="key-shortcut">1</span></div>
            <div class="mode-button" data-mode="1">Diatonic <span class="key-shortcut">2</span></div>
            <div class="mode-button" data-mode="2">Jazz7 <span class="key-shortcut">3</span></div>
            <div class="mode-button" data-mode="3">Jazz79 <span class="key-shortcut">4</span></div>
        </div>
    </div>
    
    <!-- Modern mobile note buttons -->
    <div id="mobile-buttons"></div>
    
    <script src="watersynth.js"></script>
    <script src="audio.js"></script>
    <script>
        // Audio functions and notes are now in audio.js
        
        // Mode visual properties for button colors
        const MODE_VISUALS = {
            0: { rimColor: 0x3498db, tintColor: '#e3f2fd' },  // Note mode - blue
            1: { rimColor: 0x4ecdc4, tintColor: '#e0f7f5' },  // Diatonic - teal tint
            2: { rimColor: 0x6c5ce7, tintColor: '#ede9ff' },  // Jazz7 - purple tint
            3: { rimColor: 0xff6b6b, tintColor: '#ffe5e5' }   // Jazz79 - red tint
        };
        
        // Function to update note button colors based on mode
        function updateNoteButtonColors() {
            const modeTint = MODE_VISUALS[currentMode].tintColor;
            
            document.querySelectorAll('.mobile-note-button').forEach(button => {
                // Only update if button is not currently active
                if (!button.classList.contains('active')) {
                    // Use mode tint color directly (no individual note colors)
                    button.style.background = modeTint;
                }
            });
        }
        
        // Store note indices for audio playback (no plates needed)
        const noteIndices = MAJOR_SCALE_RATIOS.map((_, i) => i);
        
        // Keyboard controls
        const keyMap = {};
        MAJOR_SCALE_RATIOS.forEach(note => {
            if (note.key) {
                keyMap[note.key] = note;
            }
        });
        
        // Track which keys are currently pressed (to prevent repeat triggers)
        const pressedKeys = new Set();
        
        // Track mode: 0 = Note, 1 = Diatonic, 2 = Jazz7, 3 = Jazz79
        let currentMode = 0; // 0 = Note mode, 1-3 = Chord modes
        
        // Mode names
        const MODE_NAMES = ['Note', 'Diatonic', 'Jazz7', 'Jazz79'];
        
        // Function to update mode display
        function updateModeDisplay() {
            // Update visual state of mode buttons
            document.querySelectorAll('.mode-button').forEach(btn => {
                const mode = parseInt(btn.getAttribute('data-mode'));
                if (mode === currentMode) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Update note button colors based on mode
            updateNoteButtonColors();
        }
        
        // Handle mode button clicks
        document.querySelectorAll('.mode-button').forEach(btn => {
            btn.addEventListener('click', () => {
                const mode = parseInt(btn.getAttribute('data-mode'));
                currentMode = mode;
                updateModeDisplay();
            });
        });
        
        // Function to update bass mode display
        function updateBassDisplay() {
            // Update bass toggle button
            const bassToggleButton = document.querySelector('.bass-toggle-button');
            if (bassToggleButton) {
                if (window.bassMode) {
                    bassToggleButton.classList.add('active');
                } else {
                    bassToggleButton.classList.remove('active');
                }
            }
            
            // Update border on note buttons when bass is active
            document.querySelectorAll('.mobile-note-button').forEach(button => {
                if (window.bassMode) {
                    button.classList.add('bass-active');
                } else {
                    button.classList.remove('bass-active');
                }
            });
        }
        
        // Handle bass toggle button click
        document.querySelector('.bass-toggle-button')?.addEventListener('click', () => {
            window.bassMode = !window.bassMode;
            updateBassDisplay();
        });
        
        // Handle mode selection (1, 2, 3, 4 keys) and bass toggle (Space)
        document.addEventListener('keydown', (event) => {
            // Handle mode selection with number keys
            if (event.key === '1' && !event.repeat) {
                currentMode = 0; // Note mode
                updateModeDisplay();
                return;
            }
            if (event.key === '2' && !event.repeat) {
                currentMode = 1; // Diatonic
                updateModeDisplay();
                return;
            }
            if (event.key === '3' && !event.repeat) {
                currentMode = 2; // Jazz7
                updateModeDisplay();
                return;
            }
            if (event.key === '4' && !event.repeat) {
                currentMode = 3; // Jazz79
                updateModeDisplay();
                return;
            }
            
            // Handle bass toggle (Space)
            if (event.key === ' ' && !event.repeat) {
                event.preventDefault(); // Prevent page scroll
                window.bassMode = !window.bassMode;
                updateBassDisplay();
                return;
            }
        });
        
        // Initialize mode display
        updateModeDisplay();
        updateBassDisplay();
        
        // Initialize note button colors
        updateNoteButtonColors();
        
        // Create mobile-friendly buttons
        // Layout: Row 1 = La, Ti, Do, Re | Row 2 = Mi, Fa, So, La
        const mobileButtonsContainer = document.getElementById('mobile-buttons');
        const mobileButtons = [];
        const buttonByKey = {}; // Map keyboard keys to button elements
        
        MAJOR_SCALE_RATIOS.forEach((note, index) => {
            const button = document.createElement('div');
            button.className = 'mobile-note-button';
            button.setAttribute('data-note-index', index);
            button.setAttribute('data-note-key', note.key);
            
            const noteName = document.createElement('div');
            noteName.className = 'note-name';
            noteName.textContent = note.name.replace('Lower ', '');
            
            const noteKey = document.createElement('div');
            noteKey.className = 'note-key';
            noteKey.textContent = note.key.toUpperCase();
            
            button.appendChild(noteName);
            button.appendChild(noteKey);
            
            // Touch/click handlers for mobile buttons
            let isButtonPressed = false;
            
            const handleStart = (e) => {
                e.preventDefault();
                if (isButtonPressed) return;
                isButtonPressed = true;
                
                const noteIndex = parseInt(button.getAttribute('data-note-index'));
                const noteKey = `mobile-${index}-${Date.now()}`;
                
                playNoteForButton(noteIndex, noteKey);
                button.classList.add('active');
                
                // Apply mode color as background when active (darker version)
                const modeColor = MODE_VISUALS[currentMode].rimColor;
                const activeColor = '#' + modeColor.toString(16).padStart(6, '0');
                button.style.background = activeColor;
                button.style.borderRightColor = activeColor;
                button.style.borderBottomColor = activeColor;
                
                button.userData = { noteKey, noteIndex };
            };
            
            const handleEnd = (e) => {
                e.preventDefault();
                if (!isButtonPressed) return;
                isButtonPressed = false;
                
                if (button.userData) {
                    stopNoteByKey(button.userData.noteKey);
                    button.classList.remove('active');
                    
                    // Reset to mode-tinted color
                    const modeTint = MODE_VISUALS[currentMode].tintColor;
                    button.style.background = modeTint;
                    button.style.borderRightColor = '#e0e0e0';
                    button.style.borderBottomColor = '#e0e0e0';
                    
                    button.userData = null;
                }
            };
            
            // Support both touch and mouse events
            button.addEventListener('touchstart', handleStart, { passive: false });
            button.addEventListener('touchend', handleEnd, { passive: false });
            button.addEventListener('touchcancel', handleEnd, { passive: false });
            button.addEventListener('mousedown', handleStart);
            button.addEventListener('mouseup', handleEnd);
            button.addEventListener('mouseleave', handleEnd);
            
            mobileButtonsContainer.appendChild(button);
            mobileButtons.push(button);
            
            // Store button reference by key for keyboard visual feedback
            if (note.key) {
                buttonByKey[note.key] = button;
            }
        });
        
        // Resume audio on any user interaction
        document.addEventListener('click', resumeAudioContext, { once: true });
        document.addEventListener('keydown', resumeAudioContext, { once: true });
        document.addEventListener('touchstart', resumeAudioContext, { once: true });
        
        // Helper function to play note/chord for a button
        function playNoteForButton(noteIndex, noteKey) {
            if (currentMode === 0) {
                // Note mode - play single note
                const frequency = getNoteFrequency(noteIndex);
                startNote(frequency, noteKey, noteIndex);
            } else {
                // Chord modes (1 = Diatonic, 2 = Jazz7, 3 = Jazz79)
                let extensions = [];
                if (currentMode === 2) {
                    // Jazz7
                    extensions = getJazz7Extensions(noteIndex);
                } else if (currentMode === 3) {
                    // Jazz79
                    extensions = getJazz79Extensions(noteIndex);
                }
                // currentMode === 1 (Diatonic) uses empty extensions array
                startChord(noteIndex, noteKey, extensions);
            }
        }
        
        // Attack phase: Start note/chord when key is pressed
        document.addEventListener('keydown', (event) => {
            const key = event.key.toLowerCase();
            
            // Prevent repeat triggers if key is already held
            if (pressedKeys.has(key) || !keyMap[key]) {
                return;
            }
            
            pressedKeys.add(key);
            
            const noteIndex = MAJOR_SCALE_RATIOS.findIndex(n => n.key === key);
            const noteKey = key;
            
            // Visual feedback: activate corresponding button
            const button = buttonByKey[key];
            if (button) {
                button.classList.add('active');
                // Apply mode color as background when active (darker version)
                const modeColor = MODE_VISUALS[currentMode].rimColor;
                const activeColor = '#' + modeColor.toString(16).padStart(6, '0');
                button.style.background = activeColor;
                button.style.borderRightColor = activeColor;
                button.style.borderBottomColor = activeColor;
            }
            
            playNoteForButton(noteIndex, noteKey);
        });
        
        // Release phase: Stop note/chord when key is released
        document.addEventListener('keyup', (event) => {
            const key = event.key.toLowerCase();
            
            if (!keyMap[key]) {
                return;
            }
            
            pressedKeys.delete(key);
            
            // Visual feedback: deactivate corresponding button
            const button = buttonByKey[key];
            if (button) {
                button.classList.remove('active');
                
                // Reset to mode-tinted color
                const modeTint = MODE_VISUALS[currentMode].tintColor;
                button.style.background = modeTint;
                button.style.borderRightColor = '#e0e0e0';
                button.style.borderBottomColor = '#e0e0e0';
            }
            
            const noteKey = key;
            stopNoteByKey(noteKey);
        });
        
        // Stop all notes if window loses focus (prevents stuck notes)
        window.addEventListener('blur', () => {
            stopAllNotes();
            pressedKeys.clear();
            
            // Reset all button states
            document.querySelectorAll('.mobile-note-button').forEach(button => {
                button.classList.remove('active');
                
                // Reset to mode-tinted color
                const modeTint = MODE_VISUALS[currentMode].tintColor;
                button.style.background = modeTint;
                button.style.borderRightColor = '#e0e0e0';
                button.style.borderBottomColor = '#e0e0e0';
                button.userData = null;
            });
        });
    </script>
</body>
</html>
